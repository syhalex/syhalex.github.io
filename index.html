<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cyber?Space v20260226</title>

    <style>
        /* =============== 黑色(默认) =============== */
        :root {
            --primary-color: #1d9bf0;
            --primary-hover: #1a8cd8;
            --bg-color: #000000;
            --card-bg: #000000;
            --text-color: #e7e9ea;
            --text-secondary: #71767b;
            --border-color: #2f3336;
            --input-bg: #000000;
            --transition-speed: 0.3s;
        }


        /* =============== 白色 =============== */
        body.light-mode {
            --primary-color: #1d9bf0;
            --bg-color: #ffffff;
            --card-bg: #ffffff;
            --text-color: #0f1419;
            --text-secondary: #536471;
            --border-color: #eff3f4;
            --input-bg: #eff3f4;
        }

        /* 黑色背景将图标颜色反转 */
        .theme-icon {
            filter: invert(1) brightness(2);
            transition: filter 0.3s ease;
        }

        /* 当切换到白色模式时，恢复图标原始颜色 */
        body.light-mode .theme-icon {
            filter: invert(0) brightness(1);
        }

        /* 全局过渡动画：确保边框和颜色同步切换 */
        * {
            transition: background-color var(--transition-speed),
                color var(--transition-speed),
                border-color var(--transition-speed),
                box-shadow var(--transition-speed);
            box-sizing: border-box;
        }

        /* =============== 全局样式 =============== */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            overflow-y: scroll;
            overflow-x: hidden;
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }

        .wrapper {
            display: flex;
            width: 100%;
            max-width: 1300px;
            gap: 60px;
            padding: 20px;
            margin: 0 auto;
            box-sizing: border-box;
            align-items: flex-start;
            /* 关键：防止 sidebar 撑满整列导致 sticky 失效 */
        }

        .sidebar {
            width: 320px;
            flex-shrink: 0;
            /* 防止被挤压 */
            position: sticky;
            top: 20px;
            /* 依靠外层 wrapper 的 flex gap 布局，无需 left/bottom 固定坐标 */
            max-height: calc(100vh - 40px);
            /* 减去上下间距，防止溢出视口 */
            overflow-y: auto;
            /* 内容过多时内部滚动 */
            scrollbar-width: none;
            /* Firefox 隐藏滚动条 */
            -ms-overflow-style: none;
            /* IE 10+ 隐藏滚动条 */
            background: var(--bg-color);
            /* 继承背景色，避免透明 */
            z-index: 100;
            /* 低于评论框的 1000，但高于普通内容 */
            border-radius: 16px;
            /* 保持原有圆角 */
            padding: 4px 12px;
            /* 为阴影留出空间 */
            box-sizing: border-box;
            /* 确保宽度和高度包含内边距 */
        }

        .sidebar::-webkit-scrollbar {
            /* Chrome/Safari 隐藏滚动条 */
            display: none;
        }

        .main-feed {
            flex: 1;
            min-width: 0;
            max-width: 850px;
            /* 由 wrapper 的 gap 自动分隔边距，不再手工指定 margin-left */
            border: 1px solid var(--border-color);
            border-radius: 16px;
            min-height: 100vh;
            border-top: none;
            border-bottom: none;
        }

        .card {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            position: relative;
        }

        .sidebar .card {
            border: 1px solid var(--border-color);
            border-radius: 16px;
            margin-bottom: 20px;
        }


        /* ================= 按钮与图标 ================= */
        button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 9999px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s, opacity 0.2s;
        }

        button:hover {
            background: var(--primary-hover);
        }

        button.btn-outline {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }

        button.btn-outline:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        button.btn-danger {
            background: #f44336;
            color: white;
        }

        button.btn-outline-danger {
            background: transparent;
            border: 1px solid #f44336;
            color: #f44336;
        }

        button.btn-outline-danger:hover {
            background: rgba(244, 67, 54, 0.1);
        }

        button.btn-danger:hover {
            background: #d32f2f;
        }

        body.light-mode button.btn-outline:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        /* 统一 Icon 过滤逻辑 (深色模式反白) */
        .theme-icon,
        .logout-icon {
            filter: invert(1) brightness(2);
            transition: filter 0.3s ease;
        }

        body.light-mode .theme-icon,
        body.light-mode .logout-icon {
            filter: invert(0) brightness(1);
        }


        /* ================= 顶部控制图标 (对称布局) ================= */
        .top-control-icon {
            position: absolute;
            top: 15px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: transparent;
            z-index: 10;
            overflow: hidden;
        }

        .top-control-icon:hover {
            background: rgba(29, 155, 240, 0.1);
        }

        .icon-left {
            left: 15px;
        }

        .icon-right {
            right: 15px;
        }

        .top-control-icon img {
            position: absolute;
            width: 22px;
            height: 22px;
            transition: opacity var(--transition-speed) ease, transform var(--transition-speed) cubic-bezier(0.4, 0, 0.2, 1);
        }

        .icon-moon {
            opacity: 1;
            transform: scale(1) rotate(0deg);
        }

        .reaction-bar button:hover {
            opacity: 0.8;
            transform: scale(1.05);
            /* 轻微放大 */
        }



        .icon-sun {
            opacity: 0;
            transform: scale(0.5) rotate(-90deg);
        }

        body.light-mode .icon-moon {
            opacity: 0;
            transform: scale(0.5) rotate(90deg);
        }

        body.light-mode .icon-sun {
            opacity: 1;
            transform: scale(1) rotate(0deg);
        }


        /* ================= 搜索框 ================= */
        .search-container {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 9999px;
            padding: 0 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            margin-bottom: 20px;
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-container:focus-within {
            border-color: var(--primary-color);
        }

        .search-input {
            border: none;
            background: transparent;
            padding: 12px 40px 12px 16px;
            /* 右侧留出按钮空间 */
            width: 100%;
            font-size: 0.95rem;
            font-family: inherit;
            font-weight: normal;
            line-height: normal;
            box-sizing: border-box;
            color: var(--text-color);
            outline: none;
            position: relative;
            z-index: 2;
            caret-color: var(--text-color);
        }

        .search-input[contenteditable] {
            white-space: pre;
            overflow-x: auto;
            overflow-y: hidden;
            min-height: 42px;
            padding-right: 36px;
        }

        /* 隐藏 contenteditable 的滚动条保持 input 的视觉效果 */
        .search-input[contenteditable]::-webkit-scrollbar {
            display: none;
        }

        .search-input[contenteditable] {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .search-input[contenteditable]:empty::before {
            content: attr(data-placeholder);
            color: var(--text-secondary);
            pointer-events: none;
            cursor: text;
        }

        .search-input:focus {
            border-color: var(--primary-color);
        }

        .search-icon-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 8px;
            z-index: 3;
            z-index: 3;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .search-icon-btn:hover {
            background: rgba(29, 155, 240, 0.1);
            color: var(--primary-color);
        }

        /* 搜索结果列表容器 */
        .search-result-list {
            padding: 0 16px;
        }

        /* ================= 发布框工具栏样式 ================= */
        /* 为了方便维护，将发布框底部的样式统一在这里管理 */

        textarea {
            width: 100%;
            background: transparent;
            border: none;
            border-bottom: 1px solid transparent;
            /* 默认隐藏线 */
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
            color: var(--text-color);
            padding: 10px 6px;
            resize: none;
            outline: none;
            font-size: 1.1rem;
            box-sizing: border-box;
        }

        textarea::-webkit-scrollbar {
            display: none;
        }

        textarea:focus {
            box-shadow:
                0 0 0 1.2px var(--primary-color);
        }

        .toolbar {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            gap: 8px;
        }

        .edit-buttons-row {
            display: flex;
            gap: 8px;
            align-items: center;
            width: 100%;
            justify-content: flex-end;
            order: 10;
        }

        .edit-buttons-row .post-btn {
            white-space: nowrap;
        }

        .edit-buttons-row .post-btn[style*="transparent"]:hover {
            background: rgba(128, 128, 128, 0.2) !important;
        }

        #mainPostBtn {
            margin-left: auto;
            order: 10;
        }

        /* 收藏图标动画 */
        .bookmark-icon {
            transition: transform 0.2s ease, filter 0.2s ease;
        }

        .active-bookmark .bookmark-icon {
            transform: scale(1.35);
        }

        /* 个人主页背景图 */
        .profile-page-header {
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px 20px 46px;
            text-align: center;
        }

        .profile-banner-bg {
            position: absolute;
            inset: 0;
            background-size: cover;
            background-position: center;
            z-index: 0;
        }

        .profile-banner-bg::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(to bottom, rgba(0, 0, 0, 0.2), rgba(0, 0, 0, 0.65));
        }

        .profile-page-header.has-banner .profile-page-name,
        .profile-page-header.has-banner .profile-page-bio {
            color: #fff;
            text-shadow: 0 1px 4px rgba(0, 0, 0, 0.5);
        }

        .profile-page-bio {
            word-break: break-all;
            overflow-wrap: break-word;
            max-width: 100%;
        }

        .profile-page-header>*:not(.profile-banner-bg):not(.banner-upload-btn) {
            position: relative;
            z-index: 1;
        }

        .banner-upload-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 5px 12px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.4);
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(4px);
            color: var(--text-color);
            cursor: pointer;
            font-size: 0.8rem;
            transition: background 0.2s;
            z-index: 1;
        }

        .profile-page-header.has-banner .banner-upload-btn {
            color: #fff;
            border-color: rgba(255, 255, 255, 0.5);
        }

        .banner-upload-btn:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .tools-left {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 15px;
            width: 100%;
        }

        .tool-item {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            color: var(--primary-color);
            font-size: 14px;
            transition: opacity 0.2s;
        }

        .tool-item:hover {
            opacity: 0.8;
        }

        .tool-icon {
            width: 20px;
            height: 20px;
            object-fit: contain;
        }

        /* 标签输入框的美化 */
        #tags {
            background: transparent;
            border: none;
            border-bottom: 1px solid transparent;
            color: var(--text-color);
            outline: none;
            width: 100%;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        #tags:focus {
            border-bottom: 1px solid var(--primary-color);
        }

        #tags::placeholder {
            color: var(--text-secondary);
        }

        .post-btn {
            padding: 6px 20px;
            border-radius: 20px;
            font-size: 14px;
        }

        .sidebar .card:not(.profile-card) {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* ================= 个人资料卡 ================= */
        .profile-card {
            text-align: center;
            border: 1px solid var(--border-color) !important;
            padding: 20px;
            position: relative;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* ================= 统一头像组件 ================= */
        .avatar {
            border-radius: 50%;
            border: 1px solid var(--border-color);
            object-fit: cover;
            background: var(--border-color);
            flex-shrink: 0;
        }

        .avatar-large {
            width: 80px;
            height: 80px;
            margin: 10px auto 10px;
        }

        .avatar-small {
            width: 40px;
            height: 40px;
        }

        .avatar-mini {
            width: 32px;
            height: 32px;
        }

        .profile-name {
            font-weight: 800;
            font-size: 1.2rem;
            margin-bottom: 12px;
        }

        .profile-bio {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 15px;
            text-align: center;
            word-break: break-all;
            overflow-wrap: break-word;
            width: 100%;
        }


        /* ================= 推文布局 ================= */
        .tweet-header {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }

        .avatar-small {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            background: var(--border-color);
            object-fit: cover;
        }

        .username {
            font-weight: bold;
            margin-right: 5px;
            color: var(--text-color);
            font-size: 1.1rem;
        }

        .timestamp {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .tweet-body {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin-left: 50px;
        }

        .tweet-content-left {
            flex: 1;
            min-width: 0;
        }

        .tweet-text {
            font-size: 1rem;
            line-height: 1.5;
            white-space: pre-wrap;
            margin-bottom: 10px;
            color: var(--text-color);
        }

        .tweet-media-right {
            width: 120px;
            flex-shrink: 0;
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .tweet-media-right.active {
            display: flex;
        }

        .tweet-media-right img,
        .tweet-media-right video {
            width: 120px;
            height: 120px;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            object-fit: cover;
            display: block;
        }

        /* 强制推文文本换行 */
        .tweet-text {
            word-break: break-word;
            /* 兼容性更好 */
            overflow-wrap: break-word;
            /* 现代标准 */
        }

        /* 标签容器允许换行 */
        .tweet-content-left div:last-child {
            /* 标签所在的 div */
            display: flex;
            flex-wrap: wrap;
            gap: 4px 8px;
            /* 标签间距，可调整 */
        }

        /* 可选：确保左侧内容区不压缩 */
        .tweet-content-left {
            min-width: 0;
            /* 已有，确保 */
            width: 100%;
            /* 强制占满剩余空间 */
        }

        /*  reaction栏 */
        .tweet-footer {
            display: flex;
            justify-content: space-between;
            max-width: 450px;
            margin-top: 12px;
            padding: 0 10px;
        }

        .action-item {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 60px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 15px;
            background: transparent !important;
            border: none;
            padding: 6px 0;
            transition: color 0.2s ease;
            position: relative;
        }

        .action-item:hover {
            color: var(--primary-color);
        }

        /* Like: 红色 */
        .action-item.type-like:hover,
        .action-item.active-like {
            color: #f91880;
        }

        .action-item.type-like:hover .action-icon,
        .action-item.active-like .action-icon {
            filter: grayscale(0) opacity(1) !important;
        }

        /* Confused: 橙色 */
        .action-item.type-confused:hover,
        .action-item.active-confused {
            color: #fd7e14;
        }

        .action-item.type-confused:hover .action-icon,
        .action-item.active-confused .action-icon {
            filter: grayscale(0) opacity(1) !important;
        }

        /* ================= Toast Notification ================= */
        .toast-banner {
            position: fixed;
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(29, 155, 240, 0.92);
            color: white;
            padding: 12px 24px;
            border-radius: 20px;
            font-size: 1rem;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 9999;
            transition: top 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none;
        }

        .toast-banner.toast-error {
            background: rgba(255, 60, 60, 0.92);
        }

        .toast-banner.toast-success {
            background: rgba(34, 197, 94, 0.92);
        }

        .toast-banner.show {
            top: 40px;
        }

        /* OMG: 绿色 */
        .action-item.type-omg:hover,
        .action-item.active-omg {
            color: #82c91e;
        }

        .action-item.type-omg:hover .action-icon,
        .action-item.active-omg .action-icon {
            filter: grayscale(0) opacity(1) !important;
        }

        .action-icon {
            width: 20px;
            height: 20px;
            transition: transform 0.2s;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275), filter 0.3s ease;
            filter: grayscale(100%);
            /* 默认让图标变成灰色调，适应黑白主题 */
            opacity: 0.7;
        }

        /* 激活或 hover 时的图标效果 */
        .action-item:hover .action-icon,
        .action-item[class*="active-"] .action-icon {
            filter: grayscale(0);
            /* 恢复彩色 */
            opacity: 1;
            transform: scale(1.15);
            /* 微微放大 */
        }

        /* 只有深色模式下，非激活状态的图标需要反色才能看清(如果是黑色图标) */
        body:not(.light-mode) .action-icon {
            filter: invert(1) grayscale(100%) brightness(0.8);
            opacity: 0.8;
            transition: filter 0.3s ease, opacity 0.3s ease;
        }

        body:not(.light-mode) .action-item:hover .action-icon,
        body:not(.light-mode) .action-item[class*="active-"] .action-icon {
            filter: invert(0) grayscale(0) brightness(1);
            opacity: 1;
        }


        /* ================= Modal & Preview ================= */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(8px);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .modal {
            background: var(--bg-color);
            padding: 25px;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            border: 1px solid var(--border-color);
        }

        .modal input[type="text"] {
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            margin-bottom: 10px;
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            color: var(--text-color);
            box-sizing: border-box;
        }

        /* Modal 内部布局样式 */
        .modal-content-wrapper {
            display: flex;
            gap: 20px;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .modal-left-col {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .modal-right-col {
            width: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* 自定义上传按钮样式 */
        .upload-avatar-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--primary-color);
            border: 1px dashed var(--border-color);
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 5px;
            font-size: 0.9rem;
            justify-content: center;
            transition: 0.2s;
        }

        .upload-avatar-btn:hover {
            background: rgba(29, 155, 240, 0.1);
            border-color: var(--primary-color);
        }

        /* 头像预览圆图样式 */
        .avatar-preview-circle {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--border-color);
            background: var(--bg-color);
            margin-top: 5px;
        }

        .preview-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }


        #previewContainer {
            display: none;
            margin-top: 10px;
            position: relative;
        }

        /* ================= 多文件预览网格 ================= */
        .preview-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }

        .preview-grid-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            aspect-ratio: 1;
            background: var(--border-color);
        }

        .preview-grid-item img,
        .preview-grid-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .preview-grid-item .remove-item {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(0, 0, 0, 0.75);
            color: white;
            border: none;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 14px;
            line-height: 22px;
            text-align: center;
            cursor: pointer;
            z-index: 5;
            padding: 0;
            transition: background 0.2s;
        }

        .preview-grid-item .remove-item:hover {
            background: rgba(255, 0, 0, 0.8);
        }

        /* ================= 列表页媒体计数徽标 ================= */
        .media-count-badge {
            color: var(--primary-color);
            font-size: 0.85rem;
            font-weight: bold;
            background: rgba(29, 155, 240, 0.1);
            padding: 4px 10px;
            border-radius: 12px;
            white-space: nowrap;
        }

        /* ================= 详情页多媒体网格 ================= */
        .media-grid {
            display: grid;
            gap: 4px;
            margin-top: 15px;
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            max-height: 600px;
        }

        .media-grid.media-grid-1 {
            grid-template-columns: 1fr;
        }

        .media-grid.media-grid-2 {
            grid-template-columns: 1fr 1fr;
        }

        .media-grid.media-grid-3 {
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
        }

        .media-grid.media-grid-3 .media-grid-item:first-child {
            grid-row: 1 / 3;
        }

        .media-grid.media-grid-4 {
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
        }

        .media-grid-item {
            overflow: hidden;
            cursor: zoom-in;
            position: relative;
            background: #000;
            min-height: 120px;
        }

        .media-grid-item img,
        .media-grid-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .media-grid-item .grid-more-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.55);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            font-weight: bold;
            pointer-events: none;
        }

        /* ================= Lightbox 导航 ================= */
        .lightbox-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border: none;
            font-size: 2rem;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            z-index: 2001;
            padding: 0;
        }

        .lightbox-nav:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .lightbox-nav.prev {
            left: 20px;
        }

        .lightbox-nav.next {
            right: 20px;
        }

        .lightbox-counter {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            background: rgba(0, 0, 0, 0.5);
            padding: 4px 12px;
            border-radius: 12px;
        }

        /* ================= 详情页与全屏组件 (新增) ================= */
        /* 1. 全屏查看器 */
        #mediaLightbox {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            cursor: zoom-out;
        }

        #lightboxContent img,
        #lightboxContent video {
            max-width: 95%;
            max-height: 90vh;
            border-radius: 4px;
        }

        /* ================= 搜索列表页头部 ================= */
        .search-header {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 10px 16px;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            background: var(--bg-color);
            z-index: 1001;
            /* Set higher than comment float bar */
        }

        /* 2. 详情页头部 */
        .detail-header {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 10px 16px;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            background: rgba(var(--bg-color), 0.85);
            /* 需配合 backdrop-filter */
            background: var(--bg-color);
            /* 降级方案 */
            z-index: 1001;
            /* Set higher than comment float bar (1000) so it doesn't get covered on narrow heights */
        }

        /* 3. 返回按钮 */
        .back-btn-circle {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: transparent;
            color: var(--text-color);
            cursor: pointer;
            transition: 0.2s;
            padding: 0;
        }

        .back-btn-circle:hover {
            background: rgba(29, 155, 240, 0.1);
        }

        /* 4. 详情页大图 */
        .detail-media-large {
            width: 100%;
            margin-top: 15px;
            border-radius: 16px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            cursor: zoom-in;
            max-height: 600px;
        }

        .detail-media-large img,
        .detail-media-large video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
            background: #000;
        }

        /* 5. 评论区样式 */
        .comment-box-area {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 12px;
        }

        .comment-input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-color);
            font-size: 1.1rem;
            outline: none;
        }

        .comment-item {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 12px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* 底部悬浮评论框 */
        .comment-float-bar {
            position: fixed;
            /* 固定定位 */
            bottom: 20px;
            /* 距离视口底部 20px */
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            padding: 16px 18px 12px 18px;
            display: flex;
            gap: 12px;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            /* 确保在最上层 */
            transition: background-color var(--transition-speed),
                border-color var(--transition-speed),
                box-shadow var(--transition-speed);
            box-sizing: border-box;
            /* 移除之前的 margin 和 width:auto */
            width: auto;
            /* 宽度将由 JS 动态设置 */
            left: 0;
            /* 初始 left 也由 JS 动态设置 */
        }

        /* 仅在深色模式下应用悬浮感毛玻璃与向上软阴影 */
        html[data-theme='dark'] .comment-float-bar {
            background: rgba(21, 32, 43, 0.85);
            /* 半透明的深色背景 */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.6), 0 4px 12px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* 二级评论相关样式 */
        .reply-wrapper {
            margin-top: 10px;
            background: var(--hover-bg);
            /* 跟其他可点击元素的悬停色保持一致的微灰/深灰 */
            border-radius: 12px;
            padding: 12px 16px;
        }

        .reply-header {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-weight: 500;
        }

        .reply-item {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
        }

        .reply-item:last-child {
            margin-bottom: 0;
        }

        .reply-content {
            flex: 1;
        }

        .reply-user-line {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 2px;
        }

        .reply-username {
            font-weight: bold;
            font-size: 0.95rem;
        }

        .reply-time {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        .reply-text-container {
            font-size: 0.95rem;
            line-height: 1.5;
            color: var(--text-color);
        }

        .reply-text-clamped {
            display: -webkit-box;
            -webkit-line-clamp: 5;
            line-clamp: 5;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .reply-expand-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            padding: 0;
            margin-top: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .reply-expand-btn:hover {
            text-decoration: underline;
        }

        .comment-actions {
            display: flex;
            gap: 16px;
            margin-top: 6px;
        }

        .comment-action-btn {
            background: none !important;
            border: none;
            outline: none;
            box-shadow: none;
            color: var(--text-secondary);
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            padding: 0;
            border-radius: 0;
            transition: none;
        }

        .comment-action-btn span,
        .comment-action-btn img {
            transition: none;
        }

        .comment-action-btn:focus,
        .comment-action-btn:focus-visible {
            outline: none;
            box-shadow: none;
            background: none !important;
        }

        .comment-action-btn:hover {
            color: var(--primary-color);
            background: none !important;
        }

        .comment-action-btn.active {
            color: #f91880;
        }

        .comment-action-btn.active-bookmark {
            color: #f5a623;
        }

        .comment-action-btn img {
            width: 16px;
            height: 16px;
            filter: grayscale(100%);
            opacity: 0.7;
        }

        body:not(.light-mode) .comment-action-btn img {
            filter: invert(1) grayscale(100%) brightness(0.8);
            opacity: 0.8;
        }

        .comment-action-btn:hover img,
        .comment-action-btn.active img,
        .comment-action-btn.active-bookmark img {
            filter: grayscale(0) !important;
            opacity: 1 !important;
        }

        /* 头像-微型 用于二级评论 */
        .avatar-tiny {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }

        /* 文本截断 - 展开按钮改为斜体覆盖 */
        .comment-text-clamped {
            display: -webkit-box;
            -webkit-line-clamp: 5;
            line-clamp: 5;
            -webkit-box-orient: vertical;
            overflow: hidden;
            position: relative;
        }

        .text-expand-btn {
            background: none !important;
            border: none;
            color: var(--text-secondary);
            font-style: italic;
            padding: 0;
            margin-top: 2px;
            cursor: pointer;
            font-size: 0.9rem;
            display: none;
            border-radius: 0;
        }

        .text-expand-btn:hover {
            color: var(--primary-color);
            background: none !important;
        }

        .text-expand-btn:focus {
            outline: none;
            background: none !important;
        }

        /* 更多回复按钮 */
        .more-replies-btn {
            background: none !important;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 0.9rem;
            padding: 6px 0;
            margin-top: 4px;
            border-radius: 0;
        }

        .more-replies-btn:hover {
            text-decoration: underline;
            background: none !important;
        }

        .more-replies-btn:focus {
            outline: none;
        }

        /* 统一评论时间样式 */
        .comment-time {
            color: var(--text-secondary);
            font-size: 0.8rem;
            white-space: nowrap;
        }

        /* 详情页评论数入口 */
        .detail-comment-count-btn {
            background: none !important;
            border: none;
            outline: none;
            color: var(--text-secondary);
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 5px 8px;
            border-radius: 0;
        }

        .detail-comment-count-btn:hover {
            color: var(--primary-color);
            background: none !important;
        }

        .detail-comment-count-btn:focus {
            outline: none;
        }

        body:not(.light-mode) .detail-comment-count-btn img {
            filter: invert(1) grayscale(100%) brightness(0.8);
            opacity: 0.8;
        }

        .detail-comment-count-btn:hover img {
            filter: grayscale(0) !important;
            opacity: 1 !important;
        }

        /* 个人主页样式 */
        .profile-page-header {
            text-align: center;
            padding: 30px 16px 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .profile-page-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: none;
        }

        .profile-page-name {
            font-size: 1.4rem;
            font-weight: bold;
            margin-top: 12px;
        }

        .profile-page-bio {
            color: var(--text-secondary);
            margin-top: 6px;
            font-size: 0.95rem;
        }

        .profile-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
        }

        .profile-tab {
            flex: 1;
            text-align: center;
            padding: 14px 0;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
            transition: 0.2s;
            background: none;
            border-top: none;
            border-left: none;
            border-right: none;
            outline: none;
            font-size: 0.95rem;
            border-radius: 0;
        }

        .profile-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .profile-tab:hover {
            background: rgba(29, 155, 240, 0.05);
        }

        .profile-tab:focus {
            outline: none;
        }

        .profile-sort-bar {
            display: flex;
            justify-content: flex-end;
            padding: 8px 16px;
            gap: 8px;
        }

        .sort-btn {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 4px 12px;
            border-radius: 16px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .sort-btn.active {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .sort-btn:focus {
            outline: none;
        }

        /* 侧边栏底部按钮行 */
        .sidebar-bottom-row {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            align-items: center;
        }

        .sidebar-bottom-row .profile-page-btn {
            flex: 1;
            border-radius: 9999px;
        }

        .sidebar-bottom-row .logout-circle-btn {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: 1px solid var(--border-color);
            cursor: pointer;
            padding: 0;
            flex-shrink: 0;
        }

        .sidebar-bottom-row .logout-circle-btn:hover {
            background: rgba(244, 67, 54, 0.1);
            border-color: #f44336;
        }

        .sidebar-bottom-row .logout-circle-btn img {
            width: 20px;
            height: 20px;
        }

        /* 头像容器：垂直排列 */
        .comment-float-bar .avatar-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            gap: 4px;
            /* 头像与昵称间距 */
            flex-shrink: 0;
        }

        /* 昵称样式 */
        .comment-float-bar .avatar-nickname {
            font-size: 0.8rem;
            font-weight: bold;
            color: var(--text-secondary);
            max-width: 60px;
            /* 限制宽度，防止过长 */
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            text-align: center;
        }

        .comment-float-bar .avatar-small {
            margin-right: 0;
        }

        .comment-float-bar .comment-input {
            width: 100%;
            padding: 8px 12px 40px 12px;
            /* 底部留空避免按钮遮挡 */
            padding-right: 72px;
            /* 右侧为按钮留水平空间 */
            box-sizing: border-box;
            flex: 1;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            color: var(--text-color);
            font-size: 1rem;
            outline: none;
            resize: none;
            overflow-y: auto;
            min-height: 60px;
            max-height: 120px;
            line-height: 1.4;
            font-family: inherit;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .comment-float-bar .input-wrapper {
            flex: 1;
            /* 占满剩余宽度 */
            position: relative;
            /* 为按钮绝对定位提供参考 */
        }

        .comment-float-bar .comment-input::-webkit-scrollbar {
            display: none;
            /* Chrome/Safari 隐藏滚动条 */
        }

        .comment-float-bar .comment-input:focus {
            border-color: var(--primary-color);
        }

        .comment-float-bar .post-btn {
            position: absolute;
            bottom: 12px;
            right: 8px;
            padding: 4px 16px;
            font-size: 0.9rem;
            border-radius: 16px;
        }

        /* 为防止底部内容被固定栏遮挡，给详情容器增加底部内边距 */
        #tweetDetailView {
            display: none;
            /* 默认隐藏 */
            flex-direction: column;
            /* 垂直排列 */
        }

        #detailContent {
            /* 移除限制内部滚动的属性，让页面整体滚动 */
            padding: 0 16px 120px 16px;
        }

        /* 1. 详情页的推文文本强制换行 */
        #detailContent div[style*="font-size:1.4rem"] {
            word-break: break-word;
            overflow-wrap: break-word;
            white-space: pre-wrap;
            /* 保留换行符并自动换行 */
        }

        /* 2. 详情页的标签容器换行（多行显示） */
        #detailContent div[style*="margin: 10px 0 15px 0"] {
            display: flex;
            flex-wrap: wrap;
            gap: 4px 8px;
            /* 标签间距，可调整 */
        }

        /* 3. 列表页的标签换行 */
        .tweet-content-left div:last-child {
            display: flex;
            flex-wrap: wrap;
            gap: 4px 8px;
        }

        #tweetList .card:active {
            background-color: rgba(128, 128, 128, 0.2);
            /* 半透明灰色，适应深色/浅色主题 */
            transition: background-color 0.2s;
            /* 快速过渡，增强反馈感 */
        }

        /* ================= 响应式 ================= */
        @media (max-width: 850px) {
            body.hide-sidebar-mobile .sidebar {
                display: none !important;
            }

            .wrapper {
                flex-direction: column;
                /* 恢复原有 flex 列布局 */
                gap: 20px;
            }

            .sidebar {
                position: static;
                /* 取消固定定位 */
                width: 100%;
                max-height: none;
                overflow-y: visible;
                margin-bottom: 0;
                left: auto;
                top: auto;
            }

            .main-feed {
                margin-left: 0;
                /* 取消左边距 */
                max-width: 100%;
                width: 100%;
                /* Ensure it spans the full width available */
                border: none;
            }

            .modal-content-wrapper {
                flex-direction: column-reverse;
                align-items: center;
            }

            .modal-right-col {
                margin-bottom: 15px;
            }

            .comment-float-bar {
                left: 10px !important;
                right: 10px !important;
                width: calc(100% - 20px) !important;
                background: rgba(var(--bg-color), 0.95) !important;
                backdrop-filter: blur(10px);
                transform: none;
            }
        }

        .options-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .options-btn:hover {
            background: rgba(29, 155, 240, 0.1);
            color: var(--primary-color);
        }

        .options-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 10;
            min-width: 100px;
            overflow: hidden;
        }

        .options-menu.show {
            display: block;
        }

        .options-menu-item {
            display: block;
            width: 100%;
            padding: 8px 16px;
            text-align: left;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: var(--text-color);
            border-radius: 0;
        }

        .options-menu-item:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        body.light-mode .options-menu-item:hover {
            background: rgba(0, 0, 0, 0.08);
        }

        .options-menu-item.danger {
            color: var(--error-color, #f44336);
        }

        .clickable-tag {
            color: var(--primary-color);
            margin-right: 20px;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .clickable-tag:hover {
            text-decoration: underline;
            opacity: 0.8;
        }

        /* ================= 新用户引导页 (Onboarding) ================= */
        .onboarding-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .onboarding-modal {
            background: var(--card-bg);
            border-radius: 16px;
            width: 90%;
            max-width: 900px;
            max-height: 85vh;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            /* 防止出现滚动条 */
        }

        .onboarding-image {
            width: 100%;
            height: auto;
            border-radius: 8px;
            margin-bottom: 15px;
            display: block;
        }

        .onboarding-slide h3 {
            margin-top: 0;
            color: var(--primary-color);
            font-size: 1.4rem;
        }

        .onboarding-slide p {
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .onboarding-slide ul {
            padding-left: 20px;
            line-height: 1.6;
            margin-bottom: 0;
        }

        .onboarding-slide li {
            margin-bottom: 8px;
        }

        .onboarding-slide code {
            background: var(--bg-color);
            padding: 2px 6px;
            border-radius: 4px;
            color: var(--primary-color);
            font-family: monospace;
        }

        .onboarding-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
            border-top: 1px solid var(--border-color);
            padding-top: 20px;
        }

        .onboarding-dots {
            display: flex;
            gap: 6px;
        }

        .onboarding-dots .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--border-color);
            transition: 0.3s;
        }

        .onboarding-dots .dot.active {
            background: var(--primary-color);
            width: 16px;
            border-radius: 4px;
        }

        .onboarding-actions button {
            margin-left: 10px;
        }

        /* 引导内容平滑过渡过渡效果 */
        .fade-transition {
            transition: opacity 0.2s ease;
            opacity: 1;
        }

        .fade-transition.fade-out {
            opacity: 0;
        }

        /* 欢迎页专属入场动画 */
        @keyframes slideFadeInLeft {
            from {
                opacity: 0;
                transform: translateX(30px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .onboarding-animate-in {
            animation: slideFadeInLeft 0.7s cubic-bezier(0.2, 0.8, 0.2, 1) both;
        }

        /* 箭头摆动动画 */
        @keyframes swayArrow {

            0%,
            100% {
                transform: translateX(0);
            }

            50% {
                transform: translateX(5px);
            }
        }

        .sway-arrow {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-left: 8px;
            animation: swayArrow 1.2s ease-in-out infinite;
        }
    </style>
</head>

<body>
    <!-- 新用户引导页 -->
    <div id="onboardingOverlay" class="onboarding-overlay" style="display: none;">
        <div class="onboarding-modal">
            <!-- 欢迎界面 -->
            <div id="onboardingWelcome" class="fade-transition"
                style="display: flex; flex-direction: column; align-items: flex-start; justify-content: center; flex: 1; text-align: left; gap: 30px; padding: 20px 40px;">
                <h2 class="onboarding-animate-in"
                    style="font-size: 2.2rem; margin: 0; font-weight: 800; color: var(--text-color);">欢迎
                </h2>
                <p class="onboarding-animate-in"
                    style="font-size: 1.1rem; color: var(--text-secondary); margin: -15px 0 0 0; animation-delay: 0.1s;">
                    这是一个快速引导界面</p>
                <div class="onboarding-animate-in" style="display: flex; gap: 20px; animation-delay: 0.2s;">
                    <button class="btn-outline" onclick="finishOnboarding()"
                        style="padding: 12px 30px; font-size: 1.1rem;">跳过</button>
                    <button class="post-btn" onclick="startOnboardingSteps()"
                        style="padding: 12px 30px; font-size: 1.1rem; display: flex; align-items: center;">
                        开始
                        <span class="sway-arrow">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="5" y1="12" x2="19" y2="12"></line>
                                <polyline points="12 5 19 12 12 19"></polyline>
                            </svg>
                        </span>
                    </button>
                </div>
            </div>

            <div id="dynamicOnboardingContainer" class="fade-transition"
                style="display: none; flex-direction: row; flex: 1; min-height: 0; align-items: stretch; justify-content: space-between; gap: 20px;">
                <!-- 左侧文字 -->
                <div
                    style="flex: 1; display: flex; flex-direction: column; justify-content: center; text-align: left; padding-right: 10px;">
                    <div id="guideUserTitle"
                        style="font-size: 1.8rem; font-weight: 800; margin-bottom: 15px; color: var(--text-color);">
                    </div>
                    <div id="guideUserText"
                        style="line-height: 1.6; font-size: 1.05rem; overflow-y: auto; white-space: pre-wrap;">
                        加载中...</div>
                </div>
                <!-- 右侧图片 -->
                <img src="" class="onboarding-image" id="guideUserImg" alt="预览"
                    style="display:none; flex: 1; min-height: 0; object-fit: contain; max-width: 50%; max-height: 100%; margin-bottom: 0;">
            </div>

            <div class="onboarding-footer fade-transition" id="onboardingFooter"
                style="display: none; flex-shrink: 0; align-items: center; justify-content: space-between;">
                <!-- 左侧：页码和指示点 -->
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div id="guideUserPageCount"
                        style="font-size: 1.5rem; font-weight: bold; color: var(--text-secondary); letter-spacing: 1px; line-height: 1;">
                        1/1
                    </div>
                    <div class="onboarding-dots" id="guideUserDots"
                        style="margin: 0; display: flex; align-items: center;">
                        <!-- 动态生成的小圆点 -->
                    </div>
                </div>
                <!-- 右侧：按钮 -->
                <div class="onboarding-actions" style="margin: 0;">
                    <button id="guideUserPrevBtn" class="btn-outline" style="visibility:hidden;"
                        onclick="changeOnboardingSlide(-1)">上一步</button>
                    <button id="guideUserNextBtn" class="post-btn" onclick="changeOnboardingSlide(1)">下一页</button>
                    <button id="guideUserSkipBtn" class="btn-outline" style="margin-left: 10px;"
                        onclick="finishOnboarding()">跳过</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="editModal">
        <div class="modal" style="position:relative;">
            <button onclick="closeModal()"
                style="position:absolute; top:12px; right:12px; background:transparent; border:none; color:var(--text-secondary); font-size:2rem; cursor:pointer; padding:4px 10px; line-height:1; border-radius:50%; transition:color 0.2s;"
                onmouseover="this.style.color='var(--text-color)'"
                onmouseout="this.style.color='var(--text-secondary)'">&times;</button>
            <h2 style="margin-top:0">修改资料</h2>

            <div class="modal-content-wrapper">
                <div class="modal-left-col">
                    <div class="form-group">
                        <input type="text" id="editNickname" placeholder="输入新昵称" maxlength="20">
                        <div id="nicknameCheckMsg" style="font-size:0.8rem; margin-top:-5px; margin-bottom:10px;"></div>
                    </div>
                    <div class="form-group">
                        <input type="text" id="editBio" placeholder="输入个人简介, 可使用\n换行" maxlength="80">
                    </div>

                    <input type="file" id="editAvatarInput" accept="image/*" style="display:none;"
                        onchange="handleAvatarPreview(this)">
                    <label for="editAvatarInput" class="upload-avatar-btn">
                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                            <path
                                d="M19 7v2.99s-1.99.01-2 0V7h-3s.01-1.99 0-2h3V2h2v3h3v2h-3zm-3 4V8h-3V5H5c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-8h-3zM5 19l3-4 2 3 3-4 4 5H5z" />
                        </svg>
                        更换头像
                    </label>
                </div>

                <div class="modal-right-col">
                    <div class="preview-label">预览</div>
                    <img id="editAvatarPreview" class="avatar-preview-circle" src="" alt="Avatar Preview" />
                </div>
            </div>

            <div
                style="display:flex; gap:10px; margin-top:15px; border-top:1px solid var(--border-color); padding-top:15px;">
                <button onclick="saveProfile()" style="flex:2" id="saveProfileBtn">保存</button>
                <button onclick="logout()" class="btn-outline-danger" style="flex:1">退出登录</button>
                <button onclick="confirmDeleteAccount()" class="btn-danger" style="flex:1">注销账号</button>
            </div>
        </div>
    </div>

    <!-- 退出登录确认弹窗 -->
    <div id="logoutModal" class="modal-overlay">
        <div class="modal" style="max-width:350px; text-align:center;">
            <h2 style="margin-top:0;">退出登录？</h2>
            <p style="color:var(--text-secondary); margin-bottom:25px;">确定要退出当前账号吗？</p>
            <div style="display:flex; gap:15px;">
                <button onclick="confirmLogout()" style="flex:1;">是</button>
                <button onclick="closeLogoutModal()" class="btn-outline" style="flex:1;">否</button>
            </div>
        </div>
    </div>

    <div id="deleteAccountModal" class="modal-overlay">
        <div class="modal" style="max-width:380px; text-align:center;">
            <h2 style="margin-top:0; color:#f44336;">注销账号？</h2>
            <p style="color:var(--text-secondary); margin-bottom:10px;">此操作<strong
                    style="color:#f44336;">不可逆</strong>，将永久删除：</p>
            <p style="color:var(--text-secondary); margin-bottom:25px; font-size:0.9rem;">所有推文、评论、收藏和个人资料</p>
            <div style="display:flex; gap:15px;">
                <button onclick="executeDeleteAccount()" class="btn-danger" style="flex:1;">注销</button>
                <button onclick="closeDeleteAccountModal()" class="btn-outline" style="flex:1;">取消</button>
            </div>
        </div>
    </div>

    <div id="mediaLightbox" onclick="closeLightbox(event)">
        <button class="lightbox-nav prev" onclick="event.stopPropagation(); navigateLightbox(-1)">&#8249;</button>
        <div id="lightboxContent"></div>
        <button class="lightbox-nav next" onclick="event.stopPropagation(); navigateLightbox(1)">&#8250;</button>
        <div id="lightboxCounter" class="lightbox-counter" style="display:none;"></div>
    </div>

    <div class="wrapper">

        <div class="sidebar">

            <div class="search-container" onclick="document.getElementById('searchInput').focus()">
                <div id="searchInput" class="search-input" contenteditable="true" data-placeholder="搜索..."
                    onkeydown="handleSearchKey(event)"></div>
                <button class="search-icon-btn" onclick="performSearch()">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                        <path
                            d="M21.71 20.29l-5.01-5.01C17.54 13.68 18 11.91 18 10c0-4.41-3.59-8-8-8S2 5.59 2 10s3.59 8 8 8c1.91 0 3.68-.46 5.28-1.3l5.01 5.01c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41zM4 10c0-3.31 2.69-6 6-6s6 2.69 6 6-2.69 6-6 6-6-2.69-6-6z" />
                    </svg>
                </button>
            </div>

            <div class="card profile-card">
                <button class="top-control-icon icon-right" onclick="toggleTheme()" id="themeBtn" title="切换主题">
                    <img src="https://img.icons8.com/?size=100&id=45475&format=png&color=FAB005" class="icon-sun"
                        alt="Sun">
                    <img src="https://img.icons8.com/?size=100&id=84045&format=png&color=FAB005" class="icon-moon"
                        alt="Moon">
                </button>

                <div id="profileAvatarContainer"></div>
                <div class="profile-name" id="displayNickname">Loading...</div>
                <div class="profile-bio" id="displayBio">...</div>

                <button class="btn-outline" id="editProfileBtn" onclick="openModal()" style="width:100%">编辑资料</button>

                <div class="sidebar-bottom-row" id="sidebarBottomRow">
                    <button class="btn-outline profile-page-btn" id="profilePageBtn"
                        onclick="openProfilePage()">个人主页</button>
                    <button class="logout-circle-btn" onclick="logout()" title="退出登录">
                        <img src="https://img.icons8.com/?size=100&id=24337&format=png&color=000000" class="logout-icon"
                            alt="Logout">
                    </button>
                </div>
            </div>

            <div class="card" id="postCard">
                <textarea id="content" placeholder="有什么新鲜事？" rows="6"></textarea>

                <div id="previewContainer">
                    <div id="previewMedia"></div>
                </div>

                <div style="border-top: 1px solid var(--border-color); margin: 10px 0;"></div>

                <div class="toolbar">
                    <div class="tools-left">
                        <input type="file" id="fileInput" accept="image/*,video/*" multiple
                            onchange="handleFileSelect()" style="display:none;">
                        <label for="fileInput" class="tool-item">
                            <img src="https://img.icons8.com/?size=100&id=6b7l1lBTegrx&format=png&color=1A1A1A"
                                alt="icon" class="theme-icon tool-icon">
                            <span>图片/视频</span>
                        </label>

                        <label for="tags" class="tool-item">
                            <img src="https://img.icons8.com/?size=100&id=119&format=png&color=000000" alt="tag"
                                class="theme-icon tool-icon">
                            <input type="text" id="tags" placeholder="添加标签, 逗号隔开">
                        </label>
                    </div>

                    <button onclick="postTweet()" class="post-btn" id="mainPostBtn">发布</button>
                </div>
            </div>
        </div>

        <div class="main-feed">
            <div id="tweetListView">
                <div id="tweetList"></div>
            </div>

            <div id="tweetDetailView" style="display: none;">
                <div class="detail-header">
                    <button class="back-btn-circle" onclick="goBackFromDetail()">
                        <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" />
                        </svg>
                    </button>
                    <span style="font-weight: 800; font-size: 1.2rem;">详情</span>
                </div>

                <div id="detailContent"></div>
            </div>

            <!-- 搜索结果视图（默认隐藏） -->
            <div id="searchResultView" style="display: none;">
                <div class="detail-header">
                    <button class="back-btn-circle" onclick="goBackFromSearch()">
                        <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" />
                        </svg>
                    </button>
                    <span id="searchResultTitle" style="font-weight: 800; font-size: 1.2rem;">搜索</span>
                </div>
                <div id="searchResultList" class="search-result-list"></div>
            </div>

            <!-- 个人主页视图 -->
            <div id="profilePageView" style="display: none;">
                <div class="detail-header">
                    <button class="back-btn-circle" onclick="goBackFromProfile()">
                        <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" />
                        </svg>
                    </button>
                    <span style="font-weight: 800; font-size: 1.2rem;">个人主页</span>
                </div>
                <div id="profilePageContent"></div>
            </div>

        </div>

        <!-- 底部悬浮评论框（默认隐藏） -->
        <div id="commentFloatBar" class="comment-float-bar" style="display: none;">
            <div class="avatar-container">
                <img src="" id="floatAvatar" class="avatar-small" alt="">
                <span id="floatNickname" class="avatar-nickname">Loading...</span>
            </div>
            <div class="input-wrapper">
                <textarea id="floatCommentInput" class="comment-input" placeholder="发布你的评论..." rows="2"></textarea>
                <button id="floatPostCommentBtn" class="post-btn">评论</button>
            </div>
        </div>

    </div>

    <script>
        // Toggle options menu
        function toggleTweetOptions(event, id) {
            event.stopPropagation();
            const menu = document.getElementById('options-menu-' + id);
            if (menu) {
                menu.classList.toggle('show');
            }
            // Close other menus
            document.querySelectorAll('.options-menu').forEach(m => {
                if (m.id !== 'options-menu-' + id) m.classList.remove('show');
            });
        }

        // Close menus when clicking outside
        window.addEventListener('click', function () {
            document.querySelectorAll('.options-menu').forEach(m => m.classList.remove('show'));
        });

        // 脚本：API 常量、页面状态、初始化、事件处理、API 交互、DOM 渲染
        const API_BASE = 'http://localhost:5000/api';
        let currentPostFiles = [];
        let lightboxItems = [];   // Lightbox 媒体列表
        let lightboxIndex = 0;    // 当前 Lightbox 索引
        let previousView = 'list'; // 可能值: 'list', 'search'

        let currentUser = localStorage.getItem('uid');
        let currentVisitor = localStorage.getItem('visitor_id');

        if (!currentUser && !currentVisitor) {
            window.location.href = 'login.html';
        }

        function getUserId() {
            return currentUser || currentVisitor;
        }

        // 开启退出确认
        function logout() {
            document.getElementById('logoutModal').style.display = 'flex';
        }

        // 最终确认退出
        function confirmLogout() {
            localStorage.removeItem('uid');
            localStorage.removeItem('visitor_id');
            window.location.href = 'login.html';
        }

        // 取消退出
        function closeLogoutModal() {
            document.getElementById('logoutModal').style.display = 'none';
        }

        // 统一Toast提示函数  type: 'info'(默认蓝) | 'success'(绿) | 'error'(红)
        function showToast(message, type = 'info') {
            let toast = document.getElementById('globalToast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'globalToast';
                toast.className = 'toast-banner';
                document.body.appendChild(toast);
            }
            // 移除旧类型
            toast.classList.remove('toast-error', 'toast-success');
            if (type === 'error') toast.classList.add('toast-error');
            else if (type === 'success') toast.classList.add('toast-success');
            toast.innerText = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 2500);
        }

        // 统一头像组件渲染函数
        function getAvatarHtml(url, name, sizeClass = 'avatar-small') {
            const avatarUrl = url || `https://ui-avatars.com/api/?name=${encodeURIComponent(name || 'User')}&background=1d9bf0&color=fff`;
            return `<img src="${avatarUrl}" class="avatar ${sizeClass}" alt="${name}">`;
        }

        // 防抖函数
        function debounce(fn, delay) {
            let timer = null;
            return function (...args) {
                if (timer) clearTimeout(timer);
                timer = setTimeout(() => fn.apply(this, args), delay);
            };
        }

        // 校验新昵称是否重复
        const checkNickname = debounce(async (name) => {
            const msgEl = document.getElementById('nicknameCheckMsg');
            const saveBtn = document.getElementById('saveProfileBtn');
            if (!name || name === currentUser) {
                msgEl.innerText = '';
                saveBtn.disabled = false;
                return;
            }
            if (!/^[a-zA-Z0-9_\-]+$/.test(name)) {
                msgEl.innerText = '格式不合法';
                msgEl.style.color = 'var(--error-color)';
                saveBtn.disabled = true;
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/check-nickname?nickname=${encodeURIComponent(name)}`);
                const data = await res.json();
                if (data.available) {
                    msgEl.innerText = '昵称可用';
                    msgEl.style.color = '#4caf50';
                    saveBtn.disabled = false;
                } else {
                    msgEl.innerText = '昵称已被占用';
                    msgEl.style.color = '#f44336';
                    saveBtn.disabled = true;
                }
            } catch (e) {
                console.error(e);
            }
        }, 500);

        document.getElementById('editNickname').addEventListener('input', (e) => checkNickname(e.target.value));

        // 注销账号
        function confirmDeleteAccount() {
            if (!currentUser) return alert("请先登录账号。");
            document.getElementById('deleteAccountModal').style.display = 'flex';
        }

        function closeDeleteAccountModal() {
            document.getElementById('deleteAccountModal').style.display = 'none';
        }

        async function executeDeleteAccount() {
            closeDeleteAccountModal();
            await fetch(`${API_BASE}/profile?uid=${encodeURIComponent(currentUser)}`, { method: 'DELETE' });
            logout();
        }

        const ICONS = {
            like: 'https://img.icons8.com/?size=100&id=86721&format=png&color=FA5252',
            like_filled: 'https://img.icons8.com/?size=100&id=86747&format=png&color=FA5252',
            confused: 'https://img.icons8.com/?size=100&id=85965&format=png&color=FAB005',
            confused_filled: 'https://img.icons8.com/?size=100&id=98973&format=png&color=FAB005',
            omg: 'https://img.icons8.com/?size=100&id=UpwQYGKI5ULX&format=png&color=000000',
            omg_filled: 'https://img.icons8.com/?size=100&id=UpwQYGKI5ULX&format=png&color=82C91E',
            comment: 'https://img.icons8.com/?size=100&id=q8JjcqIiTjN6&format=png&color=228BE6',
            bookmark: 'https://img.icons8.com/?size=100&id=jqyot3HDDk8T&format=png&color=888888',
            bookmark_active: 'https://img.icons8.com/?size=100&id=RCNd8jKgwXj8&format=png&color=FAB005'
        };


        // 动态调整 textarea 的高度
        const autoResize = (el) => {
            el.style.height = 'auto';
            el.style.height = el.scrollHeight + 'px';
        };

        document.getElementById('content').addEventListener('input', function () {
            autoResize(this);
        });

        // 初始化时也执行一次（如果已有内容）
        autoResize(document.getElementById('content'));


        // =========================
        // 主题相关逻辑
        // =========================

        // 初始化主题（从 localStorage 恢复）
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            // 如果之前存的是 light，就给 body 加上类名
            if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
            }
        }

        function toggleTheme() {
            // 切换类名：CSS 会根据这个类名的有无，自动触发图标的渐变动画
            document.body.classList.toggle('light-mode');

            // 保存当前用户的偏好
            const isLight = document.body.classList.contains('light-mode');
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
        }


        // =========================
        // 搜索相关
        // =========================

        // 回车触发搜索
        function handleSearchKey(event) {
            if (event.key === 'Enter') {
                event.preventDefault(); // 阻止 contenteditable 产生换行
                performSearch();
            }
        }

        // ======= 光标位置保护 ======
        // 判断光标是否位于开头连续的 tag 保护区内部（在此区域禁止增添文字）
        function isCaretInProtectedZone(input) {
            const text = input.innerText.replace(/\n$/, '');
            const tagsMatch = text.match(/^(\s*(?:#\S+\s*)+)/);
            if (tagsMatch) {
                const tagZoneEnd = tagsMatch[0].replace(/\s+$/, '').length;
                const pos = saveCaretPosition(input);
                return pos < tagZoneEnd;
            }
            return false;
        }

        // 禁止在蓝色标签内部或左侧输入普通文字
        document.getElementById('searchInput').addEventListener('keydown', function (event) {
            const allowedKeys = ['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown', 'Tab', 'Enter'];
            if (allowedKeys.includes(event.key) || event.ctrlKey || event.metaKey) return;
            if (isCaretInProtectedZone(this)) {
                event.preventDefault();
            }
        });

        // 防止中文输入法在保护区前输入
        document.getElementById('searchInput').addEventListener('compositionstart', function (event) {
            if (isCaretInProtectedZone(this)) {
                this.blur();
                setTimeout(() => this.focus(), 0);
            }
        });

        // 防止粘贴或拖拽在保护区内输入
        ['paste', 'drop'].forEach(evt => {
            document.getElementById('searchInput').addEventListener(evt, function (event) {
                if (isCaretInProtectedZone(this)) {
                    event.preventDefault();
                }
            });
        });

        // 光标位置保存与恢复
        function saveCaretPosition(el) {
            const selection = window.getSelection();
            if (selection.rangeCount === 0) return 0;
            const range = selection.getRangeAt(0);
            const preCaretRange = range.cloneRange();
            preCaretRange.selectNodeContents(el);
            preCaretRange.setEnd(range.endContainer, range.endOffset);
            return preCaretRange.toString().length;
        }

        function restoreCaretPosition(el, position) {
            const selection = window.getSelection();
            const range = document.createRange();
            range.setStart(el, 0);
            range.collapse(true);

            const nodeStack = [el];
            let node, foundStart = false;
            let charIndex = 0;

            while (!foundStart && (node = nodeStack.pop())) {
                if (node.nodeType === 3) {
                    const nextCharIndex = charIndex + node.length;
                    if (position >= charIndex && position <= nextCharIndex) {
                        range.setStart(node, position - charIndex);
                        foundStart = true;
                    }
                    charIndex = nextCharIndex;
                } else {
                    let i = node.childNodes.length;
                    while (i--) {
                        nodeStack.push(node.childNodes[i]);
                    }
                }
            }
            selection.removeAllRanges();
            selection.addRange(range);
        }

        // 实时 \tag → # 替换和蓝色标签渲染
        document.getElementById('searchInput').addEventListener('input', function () {
            const input = this;
            let text = input.innerText.replace(/\n$/, ''); // 获取纯文本
            const hasTagsOrPrefix = text.includes('\\tag') || /#/.test(text);

            if (!hasTagsOrPrefix && !input.innerHTML.includes('<span')) {
                // 如果即没有 tag 又没有高亮元素，不必重新渲染，节省性能
                return;
            }

            let pos = saveCaretPosition(input);

            // 替换 \tag 为 #
            const tagRegex = /(^|\s)\\tag/g;
            if (tagRegex.test(text)) {
                tagRegex.lastIndex = 0;
                const beforeText = text.substring(0, pos);
                const matchCountBeforePos = (beforeText.match(/(^|\s)\\tag/g) || []).length;
                text = text.replace(/(^|\s)\\tag/g, '$1#');
                pos -= matchCountBeforePos * 3;
            }

            // --- 新增：强制标签自动移动到左侧（仅当标签已完成即后面跟空格时，或者不在最末尾的残余片段） ---
            let trailingTag = "";
            let textToProcess = text;
            const trailingTagMatch = text.match(/(^|\s)(#\S+)$/);
            if (trailingTagMatch) {
                trailingTag = trailingTagMatch[2];
                textToProcess = text.substring(0, text.length - trailingTag.length);
            }

            const parts = textToProcess.split(/((?:^|\s)#\S+)/g);
            let tags = [];
            let normalText = "";
            parts.forEach(part => {
                if (/(?:^|\s)#\S+/.test(part)) {
                    tags.push(part.trim());
                } else {
                    normalText += part;
                }
            });

            tags = tags.filter(t => t);

            let hasTrailingSpace = /\s$/.test(textToProcess);
            normalText = normalText.replace(/\s+/g, ' ');
            if (normalText.startsWith(' ')) normalText = normalText.substring(1);
            normalText = normalText.trimEnd();

            let expectedText = tags.join(' ');
            if (expectedText && normalText) {
                expectedText += ' ' + normalText;
            } else if (!expectedText) {
                expectedText = normalText;
            }

            if (trailingTag) {
                if (expectedText) {
                    if (trailingTagMatch[1]) expectedText += ' ';
                    expectedText += trailingTag;
                } else {
                    expectedText = trailingTag;
                }
            } else {
                if (hasTrailingSpace && expectedText) {
                    expectedText += ' ';
                }
            }

            const normalize = s => s.replace(/\s+/g, ' ').trim();
            if (normalize(text) !== normalize(expectedText)) {
                text = expectedText;
                pos = text.length; // 重排后光标跳到最后，保障输入顺畅
            }
            // ------------------------------------

            // 如果没有 # 返回纯文本
            if (!/#\S/.test(text)) {
                if (input.innerHTML !== text) {
                    input.innerHTML = escapeHtml(text).replace(/ /g, '&nbsp;');
                    restoreCaretPosition(input, pos);
                }
                return;
            }

            // 更新 HTML
            // 此时保证所有的 tags 都在前面
            const finalParts = text.split(/((?:^|\s)#\S+)/g);
            let html = '';
            finalParts.forEach(part => {
                const trimmed = part.trimStart();
                const leadingSpaces = part.substring(0, part.length - trimmed.length);

                if (trimmed.startsWith('#')) {
                    html += `<span style="color:var(--text-color);">${leadingSpaces.replace(/ /g, '&nbsp;')}</span><span style="color:var(--primary-color);">${escapeHtml(trimmed)}</span>`;
                } else if (part.length > 0) {
                    html += `<span>${escapeHtml(part).replace(/ /g, '&nbsp;')}</span>`;
                }
            });

            input.innerHTML = html;
            restoreCaretPosition(input, pos);
        });

        // 执行搜索
        async function performSearch() {
            const fullQuery = document.getElementById('searchInput').innerText.trim().replace(/\n$/, '');
            if (!fullQuery) return;

            // 提取 #tag 和普通文本
            // 只提取独立单词开头的 #tag
            const tagMatches = fullQuery.match(/(?:^|\s)#(\S+)/g);
            let tagList = [];
            let textQuery = fullQuery;

            if (tagMatches) {
                tagList = tagMatches.map(t => t.trim().substring(1)).filter(t => t);
                textQuery = fullQuery.replace(/(?:^|\s)#\S+/g, '').trim();
            }

            // 更新标题
            let title = '';
            if (textQuery && tagList.length > 0) {
                title = `"${textQuery}" + 标签: ${tagList.map(t => `#${t}`).join(' ')} 的搜索结果`;
            } else if (tagList.length > 0) {
                title = `搜索标签: ${tagList.map(t => `#${t}`).join(' ')}`;
            } else {
                title = `"${textQuery}"的搜索结果`;
            }
            document.getElementById('searchResultTitle').innerText = title;

            document.getElementById('tweetListView').style.display = 'none';
            document.getElementById('tweetDetailView').style.display = 'none';
            document.getElementById('profilePageView').style.display = 'none';
            document.getElementById('searchResultView').style.display = 'block';
            document.body.classList.add('hide-sidebar-mobile');

            const floatBar = document.getElementById('commentFloatBar');
            if (floatBar) floatBar.style.display = 'none';
            window.removeEventListener('resize', updateFloatBarPosition);

            await fetchSearchResults(textQuery, tagList);
        }

        // 获取搜索结果
        async function fetchSearchResults(query, tagList = []) {
            const listContainer = document.getElementById('searchResultList');
            listContainer.innerHTML = '<div style="padding:40px; text-align:center;">加载中...</div>';

            try {
                let url = `${API_BASE}/tweets?`;
                if (query) url += `search=${encodeURIComponent(query)}&`;
                if (tagList && tagList.length > 0) url += `tags=${encodeURIComponent(tagList.join(','))}`;

                const res = await fetch(url);
                if (!res.ok) throw new Error('搜索失败');
                const tweets = await res.json();
                renderSearchResults(tweets);
            } catch (e) {
                console.error(e);
                listContainer.innerHTML = '<div style="padding:40px; text-align:center; color:red;">加载失败</div>';
            }
        }


        // =========================
        // 页面初始化
        // =========================

        // 页面加载时，初始化主题、获取用户资料和推文列表
        let globalBookmarks = new Set();

        async function syncBookmarks() {
            const uid = getUserId();
            if (!uid || uid.startsWith('visitor_')) {
                globalBookmarks.clear();
                return;
            }
            try {
                const res = await fetch(`${API_BASE}/bookmarks?uid=${encodeURIComponent(uid)}`);
                if (res.ok) {
                    const data = await res.json();
                    globalBookmarks = new Set(data.map(t => t.id || t.tweet_id));
                }
            } catch (e) {
                console.error("Sync bookmarks failed:", e);
            }
        }

        window.onload = async function () {
            initTheme();
            fetchProfile();
            await syncBookmarks();
            fetchTweets();

            // 访客隐藏部分UI
            const uid = getUserId();
            if (!uid || uid.startsWith('visitor_')) {
                const logoutBtn = document.querySelector('.logout-circle-btn');
                if (logoutBtn) logoutBtn.style.display = 'none';
                const profilePageBtn = document.getElementById('profilePageBtn');
                if (profilePageBtn) profilePageBtn.style.display = 'none';
                const postCard = document.getElementById('postCard');
                if (postCard) postCard.style.display = 'none';
                const displayBio = document.getElementById('displayBio');
                if (displayBio) displayBio.style.display = 'none';
            }
        };


        // =========================
        // API：用户资料
        // =========================

        // 获取用户资料并更新页面显示，同时填充编辑 Modal 的初始值
        async function fetchProfile() {
            try {
                const res = await fetch(`${API_BASE}/profile?uid=${encodeURIComponent(getUserId())}`);
                const data = await res.json();

                // 更新展示区
                document.getElementById('displayNickname').innerText = data.nickname;
                document.getElementById('displayBio').innerHTML = (data.bio || '···').replace(/\\n/g, '<br>').replace(/\n/g, '<br>');
                document.getElementById('profileAvatarContainer').innerHTML = getAvatarHtml(data.avatar, data.nickname, 'avatar-large');

                // 统一同步悬浮条头像 (如果有)
                const floatAvatar = document.getElementById('floatAvatar');
                if (floatAvatar) {
                    floatAvatar.src = data.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(data.nickname)}&background=1d9bf0&color=fff`;
                    floatAvatar.className = 'avatar avatar-small';
                }
                const floatNickname = document.getElementById('floatNickname');
                if (floatNickname) floatNickname.innerText = data.nickname;

                // 填充编辑 Modal 的初始值
                document.getElementById('editNickname').value = currentUser ? data.nickname : '游客账户';
                document.getElementById('editNickname').disabled = !currentUser;
                document.getElementById('editBio').value = (data.bio || "").replace(/\n/g, '\\n');
                document.getElementById('editAvatarPreview').src = data.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(data.nickname)}&background=1d9bf0&color=fff`;

                // 处理侧边栏按钮逻辑
                const btn = document.getElementById('editProfileBtn');
                const themeBtn = document.getElementById('themeBtn');
                const profileCard = document.querySelector('.profile-card');

                if (btn) {
                    if (data.isVisitor) {
                        // 游客侧边栏弹性布局（左边登录按钮，右边主题按钮）
                        profileCard.style.display = 'flex';
                        profileCard.style.alignItems = 'center';
                        profileCard.style.justifyContent = 'space-between';

                        btn.innerText = "登录/注册";
                        btn.onclick = () => window.location.href = 'login.html';
                        btn.style.marginTop = '0';
                        btn.style.width = '75%';
                        btn.style.order = '1'; // 确保在左侧

                        if (themeBtn) {
                            themeBtn.style.position = 'static';
                            themeBtn.style.order = '2'; // 确保在右侧
                        }

                        document.getElementById('profileAvatarContainer').style.display = 'none';
                        document.getElementById('displayNickname').style.display = 'none';
                        document.getElementById('displayBio').style.display = 'none';
                        const bottomRow = document.getElementById('sidebarBottomRow');
                        if (bottomRow) bottomRow.style.display = 'none';
                    } else {
                        // 还原登录用户的常态布局
                        profileCard.style.display = 'block';

                        btn.innerText = "编辑资料";
                        btn.onclick = openModal;
                        btn.style.marginTop = '0';
                        btn.style.width = '100%';

                        if (themeBtn) {
                            themeBtn.style.position = 'absolute';
                        }

                        document.getElementById('profileAvatarContainer').style.display = 'block';
                        document.getElementById('displayNickname').style.display = 'block';
                        document.getElementById('displayBio').style.display = 'block';
                        const bottomRow = document.getElementById('sidebarBottomRow');
                        if (bottomRow) bottomRow.style.display = 'flex';
                    }
                }

            } catch (e) {
                console.error(e);
            }
        }


        // =========================
        // API：推文列表
        // =========================

        // 获取推文列表（可选搜索），并调用渲染函数更新页面
        async function fetchTweets(query = '') {
            const url = query ? `${API_BASE}/tweets?search=${encodeURIComponent(query)}` : `${API_BASE}/tweets`;
            const res = await fetch(url);
            const data = await res.json();
            renderTweets(data);
        }

        // 记录该设备或用户是否有过reaction
        // 优先使用新后端的 reactionUsers 数组判断，若由于某种原因未传，降级使用 localStorage
        function hasUserReacted(tweet, type) {
            if (tweet && tweet.reactionUsers && tweet.reactionUsers[type]) {
                const uid = getUserId();
                if (uid) {
                    return tweet.reactionUsers[type].includes(uid);
                }
            }
            // fallback
            const key = `reacted_${tweet.id}_${type}`;
            return localStorage.getItem(key) === 'true';
        }

        // 记录本地互动状态
        function saveUserReaction(tweetId, type) {
            const key = `reacted_${tweetId}_${type}`;
            localStorage.setItem(key, 'true');
        }

        // 将推文数据渲染到页面
        function renderTweets(tweets) {
            const list = document.getElementById('tweetList');
            list.innerHTML = '';

            // 如果没有推文显示提示
            if (!tweets.length) {
                list.innerHTML = `<div style="padding:40px; text-align:center; color:var(--text-secondary)">暂无内容</div>`;
                return;
            }

            tweets.forEach(tweet => {
                const card = document.createElement('div');
                card.className = 'card';
                card.style.cursor = 'pointer';

                // 点击卡片跳转详情
                card.onclick = (e) => {
                    // 如果点击的是按钮、图片或链接，不跳转
                    if (e.target.closest('button') || e.target.tagName === 'IMG' || e.target.tagName === 'VIDEO') return;
                    openDetail(tweet.id);
                };

                const avatarSrc = tweet.userAvatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(tweet.user)}&background=random`;

                let mediaHtml = '';
                let hasMedia = false;
                const mediaList = tweet.media && tweet.media.length > 0 ? tweet.media : (tweet.mediaUrl ? [{ url: tweet.mediaUrl, type: tweet.mediaType }] : []);

                if (mediaList.length > 0) {
                    hasMedia = true;
                    const first = mediaList[0];
                    if (first.type === 'video') {
                        mediaHtml = `<video src="${first.url}" controls></video>`;
                    } else {
                        mediaHtml = `<img src="${first.url}" loading="lazy">`;
                    }
                    if (mediaList.length > 1) {
                        mediaHtml += `<div class="media-count-badge">+${mediaList.length - 1} 更多...</div>`;
                    }
                }

                const tagsHtml = (tweet.tags || []).map(t => `<span class="clickable-tag" onclick="event.stopPropagation(); searchByTag('${escapeHtml(t)}')">#${escapeHtml(t)}</span>`).join('');

                // reaction 状态与配置
                const commentCount = tweet.comments ? tweet.comments.length : 0;
                const reactions = tweet.reactions || { like: 0, confused: 0, omg: 0 };

                const reactionConfig = [
                    { type: 'like', icon: 'like', iconFilled: 'like_filled', count: reactions.like, colorClass: 'type-like' },
                    { type: 'confused', icon: 'confused', iconFilled: 'confused_filled', count: reactions.confused, colorClass: 'type-confused' },
                    { type: 'omg', icon: 'omg', iconFilled: 'omg_filled', count: reactions.omg, colorClass: 'type-omg' }
                ];

                // 生成 Reaction HTML
                let actionsHtml = `
                    <button class="action-item" onclick="event.stopPropagation(); openDetail('${tweet.id}')">
                        <img src="${ICONS.comment}" class="action-icon">
                        <span>${commentCount > 0 ? commentCount : ''}</span>
                    </button>
                `;

                reactionConfig.forEach(r => {
                    const isActive = hasUserReacted(tweet, r.type);
                    const currentIcon = isActive ? ICONS[r.iconFilled] : ICONS[r.icon];
                    const activeClass = isActive ? `active-${r.type}` : '';

                    // 这里 onclick 绑定了 handleReaction
                    actionsHtml += `
                        <button class="action-item ${r.colorClass} ${activeClass}" 
                            onclick="handleReaction(event, '${tweet.id}', '${r.type}')" 
                            id="btn-${tweet.id}-${r.type}">
                            <img src="${currentIcon}" class="action-icon" id="img-${tweet.id}-${r.type}">
                            <span id="count-${tweet.id}-${r.type}">${r.count > 0 ? r.count : ''}</span>
                        </button>
                    `;
                });

                const isBookmarked = globalBookmarks.has(tweet.id);
                const bookmarkClass = isBookmarked ? 'active-bookmark' : '';
                actionsHtml += `
                    <button class="action-item ${bookmarkClass}" onclick="handleBookmark(event, '${tweet.id}')" id="btn-bookmark-${tweet.id}">
                        <img src="${isBookmarked ? ICONS.bookmark_active : ICONS.bookmark}" class="action-icon bookmark-icon">
                    </button>
                `;

                // 媒体补充文字生成逻辑
                let displayContentHtml = `<div class="tweet-text">${escapeHtml(tweet.content)}</div>`;
                if (!tweet.content && (!tweet.tags || tweet.tags.length === 0) && mediaList.length > 0) {
                    let imgCount = 0;
                    let vidCount = 0;
                    mediaList.forEach(m => m.type === 'video' ? vidCount++ : imgCount++);

                    let mediaTextParts = [];
                    if (imgCount > 0) mediaTextParts.push(`${imgCount}张图片`);
                    if (vidCount > 0) mediaTextParts.push(`${vidCount}个视频`);

                    displayContentHtml = `<div class="tweet-text" style="color:#bbbbbb; font-style:italic;">上传了${mediaTextParts.join('和')}</div>`;
                }

                let originalTime = tweet.timestamp;
                let editTimeStr = "";
                if (tweet.timestamp && tweet.timestamp.includes('编于')) {
                    originalTime = new Date(parseInt(tweet.id)).toLocaleString();
                    editTimeStr = tweet.timestamp.replace('编于: ', '').trim();
                }

                // 使用模板字符串分行提高可读性
                card.innerHTML = `
                <div class="tweet-header">
                    ${getAvatarHtml(tweet.userAvatar, tweet.user, 'avatar-small')}
                    <div style="flex:1">
                        <span class="username">${escapeHtml(tweet.user)}</span>
                        ${tweet.timestamp && tweet.timestamp.includes('编于')
                        ? `<span class="timestamp" id="feed-ts-${tweet.id}" style="cursor:pointer; color:var(--text-secondary);" onclick="toggleEditTimeDisplay(event, 'feed-ts-${tweet.id}', '${originalTime}', '${editTimeStr}')">最后编辑于 ${editTimeStr}</span>`
                        : `<span class="timestamp">${tweet.timestamp}</span>`
                    }
                    </div>
                </div>

                <div class="tweet-body" style="display:block;"> 
                    <div style="display:flex; justify-content:space-between; gap:15px;">
                        <div class="tweet-content-left">
                            ${displayContentHtml}
                            <div>${tagsHtml}</div>
                        </div>
                        <div class="tweet-media-right ${hasMedia ? 'active' : ''}">
                            ${mediaHtml}
                        </div>
                    </div>

                    <div class="tweet-footer">
                        ${actionsHtml}
                    </div>
                </div>
            `;

                list.appendChild(card);
            });
        }

        // 获取搜索结果
        async function fetchSearchResults(query) {
            const listContainer = document.getElementById('searchResultList');
            listContainer.innerHTML = '<div style="padding:40px; text-align:center;">加载中...</div>';

            try {
                const res = await fetch(`${API_BASE}/tweets?search=${encodeURIComponent(query)}`);
                if (!res.ok) throw new Error('搜索失败');
                const tweets = await res.json();
                renderSearchResults(tweets);
            } catch (e) {
                console.error(e);
                listContainer.innerHTML = '<div style="padding:40px; text-align:center; color:red;">加载失败</div>';
            }
        }

        // 渲染搜索结果
        function renderSearchResults(tweets) {
            const list = document.getElementById('searchResultList');
            list.innerHTML = '';

            if (!tweets.length) {
                list.innerHTML = `<div style="padding:40px; text-align:center; color:var(--text-secondary)">暂无内容</div>`;
                return;
            }

            tweets.forEach(tweet => {
                const card = document.createElement('div');
                card.className = 'card';
                card.style.cursor = 'pointer';

                card.onclick = (e) => {
                    if (e.target.closest('button') || e.target.tagName === 'IMG' || e.target.tagName === 'VIDEO') return;
                    // Let openDetail manage the transition to correctly record previousView
                    openDetail(tweet.id);
                };

                // 生成卡片内容（与 renderTweets 完全一致，可复制过来，但注意确保使用了 escapeHtml 等函数）
                const avatarSrc = tweet.userAvatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(tweet.user)}&background=random`;

                let mediaHtml = '';
                let hasMedia = false;
                const mediaList = tweet.media && tweet.media.length > 0 ? tweet.media : (tweet.mediaUrl ? [{ url: tweet.mediaUrl, type: tweet.mediaType }] : []);

                if (mediaList.length > 0) {
                    hasMedia = true;
                    const first = mediaList[0];
                    if (first.type === 'video') {
                        mediaHtml = `<video src="${first.url}" controls></video>`;
                    } else {
                        mediaHtml = `<img src="${first.url}" loading="lazy">`;
                    }
                    if (mediaList.length > 1) {
                        mediaHtml += `<div class="media-count-badge">+${mediaList.length - 1} 更多...</div>`;
                    }
                }

                const tagsHtml = (tweet.tags || []).map(t => `<span class="clickable-tag" onclick="event.stopPropagation(); searchByTag('${escapeHtml(t)}')">#${escapeHtml(t)}</span>`).join('');

                const commentCount = (tweet.comments || []).length;
                const reactions = tweet.reactions || { like: 0, confused: 0, omg: 0 };

                const reactionConfig = [
                    { type: 'like', icon: 'like', iconFilled: 'like_filled', count: reactions.like, colorClass: 'type-like' },
                    { type: 'confused', icon: 'confused', iconFilled: 'confused_filled', count: reactions.confused, colorClass: 'type-confused' },
                    { type: 'omg', icon: 'omg', iconFilled: 'omg_filled', count: reactions.omg, colorClass: 'type-omg' }
                ];

                let actionsHtml = `
                    <button class="action-item" onclick="event.stopPropagation(); openDetail('${tweet.id}')">
                        <img src="${ICONS.comment}" class="action-icon">
                        <span>${commentCount > 0 ? commentCount : ''}</span>
                    </button>
                `;

                reactionConfig.forEach(r => {
                    const isActive = hasUserReacted(tweet, r.type);
                    const currentIcon = isActive ? ICONS[r.iconFilled] : ICONS[r.icon];
                    const activeClass = isActive ? `active-${r.type}` : '';
                    actionsHtml += `
                        <button class="action-item ${r.colorClass} ${activeClass}" 
                            onclick="handleReaction(event, '${tweet.id}', '${r.type}')" 
                            id="search-btn-${tweet.id}-${r.type}">
                            <img src="${currentIcon}" class="action-icon" id="search-img-${tweet.id}-${r.type}">
                            <span id="search-count-${tweet.id}-${r.type}">${r.count > 0 ? r.count : ''}</span>
                        </button>
                    `;
                });

                const isBookmarkedSearch = globalBookmarks.has(tweet.id);
                const bookmarkClassSearch = isBookmarkedSearch ? 'active-bookmark' : '';
                actionsHtml += `
                    <button class="action-item ${bookmarkClassSearch}" onclick="handleBookmark(event, '${tweet.id}')" id="search-btn-bookmark-${tweet.id}">
                        <img src="${isBookmarkedSearch ? ICONS.bookmark_active : ICONS.bookmark}" class="action-icon bookmark-icon">
                    </button>
                `;

                // 媒体补充文字生成逻辑
                let displayContentHtml = `<div class="tweet-text">${escapeHtml(tweet.content)}</div>`;
                if (!tweet.content && (!tweet.tags || tweet.tags.length === 0) && mediaList.length > 0) {
                    let imgCount = 0;
                    let vidCount = 0;
                    mediaList.forEach(m => m.type === 'video' ? vidCount++ : imgCount++);

                    let mediaTextParts = [];
                    if (imgCount > 0) mediaTextParts.push(`${imgCount}张图片`);
                    if (vidCount > 0) mediaTextParts.push(`${vidCount}个视频`);

                    displayContentHtml = `<div class="tweet-text" style="color:#bbbbbb; font-style:italic;">上传了${mediaTextParts.join('和')}</div>`;
                }

                let originalTime = tweet.timestamp;
                let editTimeStr = "";
                if (tweet.timestamp && tweet.timestamp.includes('编于')) {
                    originalTime = new Date(parseInt(tweet.id)).toLocaleString();
                    editTimeStr = tweet.timestamp.replace('编于: ', '').trim();
                }

                card.innerHTML = `
                    <div class="tweet-header">
                        ${getAvatarHtml(tweet.userAvatar, tweet.user, 'avatar-small')}
                        <div style="flex:1">
                            <span class="username">${escapeHtml(tweet.user)}</span>
                            ${tweet.timestamp && tweet.timestamp.includes('编于')
                        ? `<span class="timestamp" id="search-ts-${tweet.id}" style="cursor:pointer; color:var(--text-secondary);" onclick="toggleEditTimeDisplay(event, 'search-ts-${tweet.id}', '${originalTime}', '${editTimeStr}')">最后编辑于 ${editTimeStr}</span>`
                        : `<span class="timestamp">${tweet.timestamp}</span>`
                    }
                        </div>
                    </div>
                    <div class="tweet-body" style="display:block;">
                        <div style="display:flex; justify-content:space-between; gap:15px;">
                            <div class="tweet-content-left">
                                ${displayContentHtml}
                                <div>${tagsHtml}</div>
                            </div>
                            <div class="tweet-media-right ${hasMedia ? 'active' : ''}">
                                ${mediaHtml}
                            </div>
                        </div>
                        <div class="tweet-footer">
                            ${actionsHtml}
                        </div>
                    </div>
                `;

                list.appendChild(card);
            });
        }


        // =========================
        // 发布 / 编辑推文
        // =========================
        let editingTweetId = null;

        // 发布推文（包含可选文件）
        async function postTweet() {
            const uid = getUserId();
            if (!uid || uid.startsWith('visitor_')) {
                showToast("请登录后操作");
                return;
            }

            const content = document.getElementById('content').value.trim();
            const tags = document.getElementById('tags').value.trim();

            if (!content && currentPostFiles.length === 0) return showToast("内容不能为空");

            const formData = new FormData();
            formData.append('uid', getUserId());
            formData.append('content', content);
            formData.append('tags', tags);
            currentPostFiles.forEach(f => formData.append('files', f));

            try {
                if (editingTweetId) {
                    await fetch(`${API_BASE}/tweets/${editingTweetId}`, { method: 'PUT', body: formData });
                    editingTweetId = null;
                    const btn = document.getElementById('mainPostBtn');
                    if (btn) {
                        btn.innerText = '发布';
                        btn.style.display = '';
                    }
                    const editBtnRow = document.getElementById('editBtnRow');
                    if (editBtnRow) editBtnRow.style.display = 'none';
                    showToast("修改成功", 'success');
                } else {
                    await fetch(`${API_BASE}/tweets`, { method: 'POST', body: formData });
                }

                // 清理并刷新
                document.getElementById('content').value = '';
                document.getElementById('tags').value = '';
                clearPreview();
                fetchTweets();

                // 如果当前在个人主页且停留在"我的推文"或详情页，发帖/修改后同步刷新
                const profileView = document.getElementById('profilePageView');
                if (profileView && profileView.style.display !== 'none' && profileTab === 'tweets') {
                    loadProfileTabContent();
                }
                const detailView = document.getElementById('tweetDetailView');
                if (detailView && detailView.style.display !== 'none' && currentDetailTweetId) {
                    openDetail(currentDetailTweetId, true);
                }
            } catch (e) {
                console.error(e);
                showToast(editingTweetId ? "修改失败" : "发布失败", 'error');
            }
        }

        // 取消编辑状态
        function cancelEdit() {
            editingTweetId = null;
            document.getElementById('content').value = '';
            document.getElementById('tags').value = '';
            clearPreview();

            const btn = document.getElementById('mainPostBtn');
            if (btn) {
                btn.innerText = '发布';
                btn.style.display = '';
            }
            const editBtnRow = document.getElementById('editBtnRow');
            if (editBtnRow) editBtnRow.style.display = 'none';
        }

        // 启动编辑推文操作
        function editTweet(id, content, tags) {
            editingTweetId = id;
            document.getElementById('content').value = content || '';
            document.getElementById('tags').value = tags ? tags.join(', ') : '';
            clearPreview();

            const btn = document.getElementById('mainPostBtn');
            if (btn) btn.innerText = '保存修改';

            let editBtnRow = document.getElementById('editBtnRow');
            if (!editBtnRow) {
                editBtnRow = document.createElement('div');
                editBtnRow.id = 'editBtnRow';
                editBtnRow.className = 'edit-buttons-row';

                const saveBtn = document.createElement('button');
                saveBtn.className = 'post-btn';
                saveBtn.innerText = '保存';
                saveBtn.onclick = postTweet;

                const cancelBtn = document.createElement('button');
                cancelBtn.className = 'post-btn';
                cancelBtn.style.background = 'transparent';
                cancelBtn.style.color = 'var(--text-color)';
                cancelBtn.style.border = '1px solid var(--border-color)';
                cancelBtn.innerText = '取消';
                cancelBtn.onclick = cancelEdit;

                editBtnRow.appendChild(saveBtn);
                editBtnRow.appendChild(cancelBtn);

                // 插入到“发布”按钮的位置（工具栏右侧）
                const toolbar = document.querySelector('.toolbar');
                if (toolbar && btn) {
                    toolbar.insertBefore(editBtnRow, btn);
                }
            } else {
                editBtnRow.style.display = 'flex';
            }

            // 隐藏原来的发布按钮
            if (btn) btn.style.display = 'none';

            // 滚动到顶部输入框
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // 从服务器获取推文数据后启动编辑（避免内联 JS 的转义问题）
        async function startEditTweet(id) {
            try {
                const res = await fetch(`${API_BASE}/tweets/${id}`);
                if (!res.ok) throw new Error('获取推文失败');
                const tweet = await res.json();
                editTweet(id, tweet.content || '', tweet.tags || []);
            } catch (e) {
                console.error(e);
                showToast('加载推文数据失败', 'error');
            }
        }

        // 删除推文操作
        async function deleteTweet(event, id) {
            event.stopPropagation();
            if (!confirm("确定要永久删除这条推文吗？")) return;

            try {
                const res = await fetch(`${API_BASE}/tweets/${id}?uid=${encodeURIComponent(getUserId())}`, { method: 'DELETE' });
                if (res.ok) {
                    showToast("删除成功", 'success');
                    // 刷新各个视图
                    fetchTweets();
                    const profileView = document.getElementById('profilePageView');
                    if (profileView && profileView.style.display !== 'none') {
                        loadProfileTabContent();
                    }
                    const detailView = document.getElementById('tweetDetailView');
                    if (detailView && detailView.style.display !== 'none' && currentDetailTweetId === id) {
                        goBackFromDetail();
                    }
                } else {
                    throw new Error("Delete failed");
                }
            } catch (e) {
                console.error(e);
                showToast("删除失败", 'error');
            }
        }




        // =========================
        // 保存资料
        // =========================

        // 监听简介输入，处理加权长度（中2英1，上限80）
        document.getElementById('editBio').addEventListener('input', function (e) {
            const val = e.target.value;
            let count = 0;
            let result = "";
            for (let i = 0; i < val.length; i++) {
                const charCode = val.charCodeAt(i);
                const weight = (charCode >= 0 && charCode <= 128) ? 1 : 2;
                if (count + weight <= 80) {
                    count += weight;
                    result += val[i];
                } else {
                    break;
                }
            }
            if (val !== result) {
                e.target.value = result;
            }
        });

        // 将编辑 Modal 的资料提交到后端并刷新显示
        async function saveProfile() {


            const newNickname = document.getElementById('editNickname').value.trim();
            const bio = document.getElementById('editBio').value.replace(/\\n/g, '\n');
            const fileInput = document.getElementById('editAvatarInput');

            const formData = new FormData();
            formData.append('uid', currentUser);
            if (newNickname && newNickname !== currentUser) {
                formData.append('newNickname', newNickname);
            }
            formData.append('bio', bio);
            if (fileInput.files[0]) formData.append('avatar', fileInput.files[0]);

            const res = await fetch(`${API_BASE}/profile`, { method: 'POST', body: formData });
            const data = await res.json();

            if (res.ok) {
                if (newNickname && newNickname !== currentUser) {
                    localStorage.setItem('uid', newNickname);
                    currentUser = newNickname;
                }
                closeModal();
                fetchProfile();
                fetchTweets();

                // 同步刷新个人主页（如果当前显示）
                const profileView = document.getElementById('profilePageView');
                if (profileView && profileView.style.display !== 'none') {
                    renderProfilePage();
                }
            } else {
                alert(data.error || "保存失败");
            }
        }


        // =========================
        // 预览与文件处理
        // =========================

        // 处理用户选择的文件（图片或视频）并创建本地预览
        function handleFileSelect() {
            const files = Array.from(document.getElementById('fileInput').files);
            if (!files.length) return;

            // 合并已有文件，限制最多9个
            const combined = [...currentPostFiles, ...files];
            if (combined.length > 9) {
                alert('最多只能上传9个文件');
                currentPostFiles = combined.slice(0, 9);
            } else {
                currentPostFiles = combined;
            }

            renderPreviewGrid();
        }

        // 渲染多文件预览网格
        function renderPreviewGrid() {
            const container = document.getElementById('previewContainer');
            const box = document.getElementById('previewMedia');

            if (currentPostFiles.length === 0) {
                container.style.display = 'none';
                box.innerHTML = '';
                return;
            }

            container.style.display = 'block';
            box.innerHTML = '';

            const grid = document.createElement('div');
            grid.className = 'preview-grid';

            currentPostFiles.forEach((file, idx) => {
                const item = document.createElement('div');
                item.className = 'preview-grid-item';

                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-item';
                removeBtn.innerHTML = '×';
                removeBtn.onclick = (e) => {
                    e.stopPropagation();
                    currentPostFiles.splice(idx, 1);
                    renderPreviewGrid();
                };
                item.appendChild(removeBtn);

                const reader = new FileReader();
                reader.onload = (e) => {
                    if (file.type.startsWith('video')) {
                        const vid = document.createElement('video');
                        vid.src = e.target.result;
                        vid.muted = true;
                        item.appendChild(vid);
                    } else {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        item.appendChild(img);
                    }
                };
                reader.readAsDataURL(file);

                grid.appendChild(item);
            });

            box.appendChild(grid);
        }

        // 处理修改头像时的实时预览
        function handleAvatarPreview(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('editAvatarPreview').src = e.target.result;
                }
                reader.readAsDataURL(file);
            }
        }

        // 清除当前预览并重置文件引用
        function clearPreview() {
            document.getElementById('fileInput').value = '';
            document.getElementById('previewContainer').style.display = 'none';
            document.getElementById('previewMedia').innerHTML = '';
            currentPostFiles = [];
        }

        // 处理点击互动 (Like, Confused, OMG)
        async function handleReaction(event, tweetId, type) {
            event.stopPropagation(); // 阻止事件冒泡 (防止未来点击卡片进入详情页时触发)

            // 先校验登录状态
            const uid = getUserId();
            if (!uid || uid.startsWith('visitor_')) {
                showToast("请登录后操作");
                return;
            }

            // 因为此时没有完整的 tweet 对象，我们直接从 DOM 读取 active 状态作为 isReacted 判断依据。
            // 乐观更新逻辑只需要知道当前在前端它是不是被激活的。
            const btnEl = document.getElementById(`btn-${tweetId}-${type}`) ||
                document.getElementById(`detail-btn-${tweetId}-${type}`) ||
                document.getElementById(`search-btn-${tweetId}-${type}`) ||
                document.getElementById(`profile-btn-${tweetId}-${type}`);

            const isReacted = btnEl ? btnEl.classList.contains(`active-${type}`) : false;
            const action = isReacted ? 'remove' : 'add';

            // 定义需要更新的前缀列表：空字符串代表列表页 ID，'detail-' 代表详情页 ID, 'search-' 代表搜索页 ID, 使三个界面的数字同步
            const prefixes = ['', 'detail-', 'search-', 'profile-'];

            // 1. 先计算新数值 (避免在循环中重复计算导致数字错乱)
            // 尝试获取任意一个存在的计数器元素作为基准
            const baseCountSpan = document.getElementById(`detail-count-${tweetId}-${type}`) || document.getElementById(`search-count-${tweetId}-${type}`) || document.getElementById(`profile-count-${tweetId}-${type}`) || document.getElementById(`count-${tweetId}-${type}`);
            let currentCount = 0;
            if (baseCountSpan) {
                // 获取当前数字（如果是空字符串则视为 0）
                currentCount = parseInt(baseCountSpan.innerText) || 0;
            }

            // 计算目标值
            let newCount = currentCount;
            if (action === 'add') {
                if (!isReacted) newCount++; // 防止快速点击导致逻辑错误
            } else {
                if (isReacted && newCount > 0) newCount--;
            }

            // 2. 遍历所有可能的界面位置 (列表页 + 详情页) 进行 乐观 UI 更新
            prefixes.forEach(prefix => {
                // 拼接对应的 ID
                const countId = `${prefix}count-${tweetId}-${type}`;
                const imgId = `${prefix}img-${tweetId}-${type}`;
                const currBtnId = `${prefix}btn-${tweetId}-${type}`;

                const countSpan = document.getElementById(countId);
                const imgEl = document.getElementById(imgId);
                const currBtnEl = document.getElementById(currBtnId);

                // 只有当元素存在于当前页面时才更新 (防止报错)
                if (countSpan && imgEl && currBtnEl) {

                    if (action === 'add') {
                        // 【增加逻辑】
                        countSpan.innerText = newCount > 0 ? newCount : '';

                        currBtnEl.classList.add(`active-${type}`);
                        const filledKey = type === 'like' ? 'like_filled' : (type === 'omg' ? 'omg_filled' : 'confused_filled');
                        imgEl.src = ICONS[filledKey];

                        // 动画效果
                        imgEl.style.transform = 'scale(1.2)';
                        setTimeout(() => imgEl.style.transform = 'scale(1)', 200);

                    } else {
                        // 【取消逻辑】
                        countSpan.innerText = newCount > 0 ? newCount : '';

                        currBtnEl.classList.remove(`active-${type}`);
                        imgEl.src = ICONS[type];

                        // 动画效果
                        imgEl.style.transform = 'scale(0.8)';
                        setTimeout(() => imgEl.style.transform = 'scale(1)', 200);
                    }
                }
            });

            // 3. 更新本地存储状态
            if (action === 'add') {
                saveUserReaction(tweetId, type);
            } else {
                localStorage.removeItem(`reacted_${tweetId}_${type}`);
            }

            // 发送请求给后端
            try {
                const res = await fetch(`${API_BASE}/tweets/${tweetId}/react`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ uid: uid, type: type, action: action })
                });

                if (!res.ok) {
                    console.error("Reaction failed");
                }
            } catch (e) {
                console.error(e);
            }
        }

        // ===================
        // 详情页逻辑 
        // ===================

        // 更新悬浮框位置，使其与右侧主内容区对齐
        function updateFloatBarPosition() {
            const floatBar = document.getElementById('commentFloatBar');
            if (!floatBar || floatBar.style.display === 'none') return;
            // 如果是移动端（小于等于850px），让 CSS 处理，不设置 left/width
            if (window.innerWidth <= 850) {
                floatBar.style.left = '';
                floatBar.style.width = '';
                return;
            }
            const mainFeed = document.querySelector('.main-feed');
            if (!mainFeed) return;

            // 确保在任何屏幕尺寸下（哪怕非常宽），悬浮框大小完全随从主feed尺寸，修正坐标
            const rect = mainFeed.getBoundingClientRect();
            floatBar.style.left = rect.left + 15 + 'px';
            floatBar.style.width = rect.width - 30 + 'px';
        }

        let currentDetailTweetId = null;

        // 打开详情页
        async function openDetail(id, isRefresh = false) {
            currentDetailTweetId = id;
            // 记录当前可见视图（如果是首次进入才记录状态）
            if (!isRefresh) {
                const searchView = document.getElementById('searchResultView');
                const profileView = document.getElementById('profilePageView');
                if (searchView && searchView.style.display === 'block') {
                    previousView = 'search';
                } else if (profileView && profileView.style.display === 'block') {
                    previousView = 'profile';
                } else {
                    previousView = 'list';
                }
            }
            // 统一隐藏旧列表视图和搜索视图、主页视图
            document.getElementById('tweetListView').style.display = 'none';
            const searchView = document.getElementById('searchResultView');
            if (searchView) searchView.style.display = 'none';
            const profileView = document.getElementById('profilePageView');
            if (profileView) profileView.style.display = 'none';

            // 1. 切换为主详情视图
            document.getElementById('tweetDetailView').style.display = 'block';
            document.body.classList.add('hide-sidebar-mobile');
            window.scrollTo(0, 0);

            const container = document.getElementById('detailContent');
            container.innerHTML = '<div style="padding:20px; text-align:center;">加载中...</div>';

            // 显示底部悬浮框
            const floatBar = document.getElementById('commentFloatBar');
            floatBar.style.display = 'flex';
            // 更新头像与昵称
            const profileAvatarImg = document.querySelector('#profileAvatarContainer img');
            if (profileAvatarImg) {
                const floatImg = document.getElementById('floatAvatar');
                floatImg.src = profileAvatarImg.src;
                floatImg.className = 'avatar avatar-small';
            }
            document.getElementById('floatNickname').innerText = document.getElementById('displayNickname').innerText;
            // 清除输入框旧内容
            document.getElementById('floatCommentInput').value = '';

            // 更新位置
            updateFloatBarPosition();
            // 监听窗口大小变化
            window.addEventListener('resize', updateFloatBarPosition);

            // 为评论按钮绑定点击事件（注意避免重复绑定）
            const postBtn = document.getElementById('floatPostCommentBtn');
            // 移除之前绑定的事件（如果有）
            postBtn.replaceWith(postBtn.cloneNode(true));
            const newPostBtn = document.getElementById('floatPostCommentBtn');
            newPostBtn.addEventListener('click', function () {
                postComment(id); // 使用当前详情页的推文 id
            });

            // 同时允许回车发送
            const floatInput = document.getElementById('floatCommentInput');
            floatInput.onkeydown = function (e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();  // 阻止默认的换行
                    postComment(id);
                }
            };

            try {
                // 2. 获取数据
                const res = await fetch(`${API_BASE}/tweets/${id}`);
                if (!res.ok) throw new Error("加载失败");
                const tweet = await res.json();

                // 3. 构建标签 HTML
                const tagsHtml = (tweet.tags || []).map(t => `<span class="clickable-tag" style="font-size:1.1rem;" onclick="event.stopPropagation(); searchByTag('${escapeHtml(t)}')">#${escapeHtml(t)}</span>`).join('');

                // 4. 构建多媒体网格 HTML
                const mediaList = tweet.media && tweet.media.length > 0 ? tweet.media : (tweet.mediaUrl ? [{ url: tweet.mediaUrl, type: tweet.mediaType }] : []);
                let mediaHtml = '';
                if (mediaList.length > 0) {
                    const gridCount = Math.min(mediaList.length, 4);
                    const gridClass = `media-grid media-grid-${gridCount}`;
                    let gridItems = '';
                    mediaList.slice(0, 4).forEach((m, idx) => {
                        const isLast = idx === 3 && mediaList.length > 4;
                        const overlayHtml = isLast ? `<div class="grid-more-overlay">+${mediaList.length - 4}</div>` : '';
                        if (m.type === 'video') {
                            gridItems += `<div class="media-grid-item" onclick="openLightbox(${JSON.stringify(mediaList).replace(/"/g, '&quot;')}, ${idx})">
                                <video src="${m.url}" muted></video>${overlayHtml}</div>`;
                        } else {
                            gridItems += `<div class="media-grid-item" onclick="openLightbox(${JSON.stringify(mediaList).replace(/"/g, '&quot;')}, ${idx})">
                                <img src="${m.url}">${overlayHtml}</div>`;
                        }
                    });
                    mediaHtml = `<div class="${gridClass}">${gridItems}</div>`;
                }

                // 5. 调用独立的评论渲染函数生成 HTML
                const commentsHtml = renderComments(tweet.comments || []);

                // 6. 渲染详情页 DOM
                // --- 动态生成 Reaction 按钮 HTML (逻辑与列表页一致) ---
                const reactions = tweet.reactions || { like: 0, confused: 0, omg: 0 };
                const reactionConfig = [
                    { type: 'like', icon: 'like', iconFilled: 'like_filled', count: reactions.like, colorClass: 'type-like' },
                    { type: 'confused', icon: 'confused', iconFilled: 'confused_filled', count: reactions.confused, colorClass: 'type-confused' },
                    { type: 'omg', icon: 'omg', iconFilled: 'omg_filled', count: reactions.omg, colorClass: 'type-omg' }
                ];

                let detailActionsHtml = '';
                reactionConfig.forEach(r => {
                    const isActive = hasUserReacted(tweet, r.type);
                    const currentIcon = isActive ? ICONS[r.iconFilled] : ICONS[r.icon];
                    const activeClass = isActive ? `active-${r.type}` : '';

                    // ID 增加了 'detail-' 前缀
                    detailActionsHtml += `
                        <button class="action-item ${r.colorClass} ${activeClass}" 
                            onclick="handleReaction(event, '${tweet.id}', '${r.type}')" 
                            id="detail-btn-${tweet.id}-${r.type}"
                            style="font-size: 0.9rem; padding: 5px 8px;"> 
                            <img src="${currentIcon}" class="action-icon" id="detail-img-${tweet.id}-${r.type}" style="width:20px; height:20px;">
                            <span id="detail-count-${tweet.id}-${r.type}" style="margin-left:4px; font-weight:bold;">${r.count > 0 ? r.count : ''}</span>
                        </button>
                    `;
                });

                // 详情页不再显示“上传了...”占位文字，仅显示实际内容（如果有）
                let displayContentHtml = tweet.content ? `<div style="font-size:1.4rem; margin:15px 0; line-height:1.4; white-space:pre-wrap;">${escapeHtml(tweet.content)}</div>` : '';

                const commentCount = (tweet.comments || []).reduce((sum, c) => sum + 1 + ((c.replies && c.replies.length) || 0), 0);

                // 收藏按钮判断（需要检查当前用户是否已收藏）
                let bookmarkBtnHtml = '';
                const currentUid = getUserId();
                if (currentUid && !currentUid.startsWith('visitor_')) {
                    const isBookmarked = globalBookmarks.has(tweet.id);
                    const bookmarkClass = isBookmarked ? 'active-bookmark' : '';
                    bookmarkBtnHtml = `
                        <button class="action-item ${bookmarkClass}" id="detail-bookmark-${tweet.id}" onclick="handleBookmark(event, '${tweet.id}')" style="font-size:0.9rem; padding:5px 8px;">
                            <img src="${isBookmarked ? ICONS.bookmark_active : ICONS.bookmark}" class="action-icon bookmark-icon" style="width:20px; height:20px;">
                        </button>`;
                }

                let originalTime = tweet.timestamp;
                let editTimeStr = "";
                if (tweet.timestamp && tweet.timestamp.includes('编于')) {
                    originalTime = new Date(parseInt(tweet.id)).toLocaleString();
                    editTimeStr = tweet.timestamp.replace('编于: ', '').trim();
                }

                container.innerHTML = `
                        <div class="tweet-header" style="padding-top:15px;">
                            ${getAvatarHtml(tweet.userAvatar, tweet.user, 'avatar-small')}
                            <div style="flex:1; display:flex; flex-direction:column;">
                                <span class="username" style="font-size:1.1rem">${escapeHtml(tweet.user)}</span>
                                ${tweet.timestamp && tweet.timestamp.includes('编于')
                        ? `<span class="timestamp" id="detail-ts-${tweet.id}" style="cursor:pointer; color:var(--text-secondary);" onclick="toggleEditTimeDisplay(event, 'detail-ts-${tweet.id}', '${originalTime}', '${editTimeStr}')">最后编辑于 ${editTimeStr}</span>`
                        : `<span class="timestamp">${tweet.timestamp}</span>`
                    }
                            </div>
                        </div>

                        ${displayContentHtml}

                        <div style="margin: 10px 0 15px 0;">${tagsHtml}</div>
                        
                        ${mediaHtml}

                        <div class="tweet-footer" style="padding:12px 16px; justify-content: flex-start; gap: 20px; margin:0;">
                            <button class="detail-comment-count-btn" onclick="document.getElementById('floatCommentInput').focus();">
                                <img src="${ICONS['comment']}" style="width:20px; height:20px;">
                                <span style="font-weight:bold;">${commentCount > 0 ? commentCount : ''}</span>
                            </button>
                            ${detailActionsHtml}
                            ${bookmarkBtnHtml}
                        </div>
                    <div style="border-top:1px solid var(--border-color); width:100%;"></div>

                    <div style="padding-bottom: 40px;">
                        ${commentsHtml}
                    </div>
                `;

                // 渲染完成后检查文本溢出，显示展开按钮
                setTimeout(() => checkCommentTextOverflow(), 100);

            } catch (e) {
                console.error(e);
                container.innerHTML = '<div style="padding:20px; color:red">加载失败</div>';
            }
        }

        // 返回列表或搜索结果
        function goBackFromDetail() {
            currentDetailTweetId = null;
            document.getElementById('tweetDetailView').style.display = 'none';
            document.getElementById('commentFloatBar').style.display = 'none';
            window.removeEventListener('resize', updateFloatBarPosition);

            if (previousView === 'search') {
                // 显示搜索结果视图，并重新搜索以更新数据
                document.getElementById('searchResultView').style.display = 'block';
                // 此时仍在 search 视图，保持 hide-sidebar-mobile 状态
                const query = document.getElementById('searchInput').value.trim();
                if (query) {
                    fetchSearchResults(query); // 重新搜索保持数据最新
                }
            } else if (previousView === 'profile') {
                document.getElementById('profilePageView').style.display = 'block';
                // 此时仍在 profile 视图，保持 hide-sidebar-mobile 状态
                loadProfileTabContent(); // 刷新数据
            } else {
                document.getElementById('tweetListView').style.display = 'block';
                document.body.classList.remove('hide-sidebar-mobile');
                fetchTweets(); // 刷新列表
            }
        }

        // 从搜索结果返回列表
        function goBackFromSearch() {
            document.getElementById('searchResultView').style.display = 'none';
            document.getElementById('tweetListView').style.display = 'block';
            document.body.classList.remove('hide-sidebar-mobile');
            document.getElementById('searchResultList').innerHTML = ''; // 清空结果
            fetchTweets(); // 刷新列表
        }

        // 发送评论
        async function postComment(id) {
            const uid = getUserId();
            if (!uid || uid.startsWith('visitor_')) {
                showToast("请登录后操作");
                return;
            }

            const input = document.getElementById(`floatCommentInput`);
            const text = input.value.trim();
            if (!text) return;

            const parentId = input.dataset.parentId || null;

            try {
                const res = await fetch(`${API_BASE}/tweets/${id}/comment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ uid: getUserId(), text, parent_id: parentId })
                });
                // 评论成功后，重新加载详情页
                if (res.ok) {
                    input.value = '';
                    input.removeAttribute('data-parent-id'); // 清除回复目标
                    input.placeholder = '发布你的回复...'; // 恢复默认提示
                    openDetail(id, true); // 传递 true 表示刷新，不覆盖 previousView
                } else {
                    const err = await res.json();
                    showToast(err.error || "评论失败");
                }
            } catch (e) {
                console.error(e);
                showToast("发表评论时发生错误");
            }
        }

        // 全屏查看图片/视频 — 多图 Lightbox
        function openLightbox(mediaArray, startIndex) {
            lightboxItems = mediaArray;
            lightboxIndex = startIndex || 0;
            renderLightbox();
            document.getElementById('mediaLightbox').style.display = 'flex';

            // 显示/隐藏导航按钮
            const prevBtn = document.querySelector('.lightbox-nav.prev');
            const nextBtn = document.querySelector('.lightbox-nav.next');
            const counter = document.getElementById('lightboxCounter');
            if (lightboxItems.length > 1) {
                prevBtn.style.display = 'flex';
                nextBtn.style.display = 'flex';
                counter.style.display = 'block';
            } else {
                prevBtn.style.display = 'none';
                nextBtn.style.display = 'none';
                counter.style.display = 'none';
            }
        }

        function renderLightbox() {
            const content = document.getElementById('lightboxContent');
            const m = lightboxItems[lightboxIndex];
            if (m.type === 'video') {
                content.innerHTML = `<video src="${m.url}" controls autoplay style="max-width:90vw; max-height:90vh"></video>`;
            } else {
                content.innerHTML = `<img src="${m.url}" style="max-width:90vw; max-height:90vh">`;
            }
            const counter = document.getElementById('lightboxCounter');
            counter.textContent = `${lightboxIndex + 1} / ${lightboxItems.length}`;
        }

        function navigateLightbox(dir) {
            lightboxIndex = (lightboxIndex + dir + lightboxItems.length) % lightboxItems.length;
            renderLightbox();
        }

        function closeLightbox(e) {
            // 只有点击背景才关闭（不阻止内部元素点击）
            if (e.target === document.getElementById('mediaLightbox')) {
                document.getElementById('mediaLightbox').style.display = 'none';
                lightboxItems = [];
            }
        }

        // 向后兼容旧的 showFullMedia 调用
        function showFullMedia(url, type) {
            openLightbox([{ url, type }], 0);
        }

        // 键盘导航
        document.addEventListener('keydown', function (e) {
            const lb = document.getElementById('mediaLightbox');
            if (lb.style.display !== 'flex') return;
            if (e.key === 'ArrowLeft') navigateLightbox(-1);
            else if (e.key === 'ArrowRight') navigateLightbox(1);
            else if (e.key === 'Escape') { lb.style.display = 'none'; lightboxItems = []; }
        });


        // =========================
        // Modal 操作 / 安全工具
        // =========================

        // 打开编辑 Modal，并同步当前资料到预览区域
        function openModal() {
            // 打开时同步当前的头像到预览区域，避免显示空白或旧图
            const profileAvatarImg = document.querySelector('#profileAvatarContainer img');
            if (profileAvatarImg) {
                document.getElementById('editAvatarPreview').src = profileAvatarImg.src;
            }
            // 清空文件选择，以免上次选择的文件残留
            document.getElementById('editAvatarInput').value = "";

            document.getElementById('editModal').style.display = 'flex';
        }

        // 关闭 Modal
        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        // ================= 工具函数 =================
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function escapeForJs(str) {
            if (!str) return '';
            return str
                .replace(/\\/g, '\\\\')
                .replace(/'/g, "\\'")
                .replace(/"/g, '\\"')
                .replace(/\n/g, '\\n')
                .replace(/\r/g, '\\r');
        }

        // 评论区独立渲染逻辑
        function renderComments(comments) {
            if (!comments || comments.length === 0) {
                return '<div style="padding: 20px; text-align: center; color: var(--text-secondary);">暂无评论</div>';
            }

            const currentUid = getUserId();

            return comments.map(c => {
                const isLikeC = currentUid && c.likes && c.likes.includes(currentUid);
                const likeIconC = isLikeC ? ICONS['like_filled'] : ICONS['like'];
                const likeClassC = isLikeC ? 'active' : '';
                const replyCount = (c.replies && c.replies.length) || 0;

                // 二级评论 HTML
                let repliesHtml = '';
                if (c.replies && c.replies.length > 0) {
                    const maxShow = 3;
                    const visibleReplies = c.replies.slice(0, maxShow);
                    const hiddenReplies = c.replies.slice(maxShow);

                    const repliesItems = visibleReplies.map(r => buildReplyItemHtml(r, currentUid)).join('');
                    const hiddenItems = hiddenReplies.map(r => buildReplyItemHtml(r, currentUid)).join('');

                    let moreBtn = '';
                    if (hiddenReplies.length > 0) {
                        moreBtn = `
                            <div id="hidden-replies-${c.id}" style="display:none;">${hiddenItems}</div>
                            <button class="more-replies-btn" id="more-btn-${c.id}" onclick="toggleMoreReplies('${c.id}', ${hiddenReplies.length})">
                                查看更多 ${hiddenReplies.length} 条回复
                            </button>`;
                    }

                    repliesHtml = `
                        <div class="reply-wrapper">
                            ${repliesItems}
                            ${moreBtn}
                        </div>
                    `;
                }

                return `
                    <div class="comment-item">
                        ${getAvatarHtml(c.avatar, c.user, 'avatar-small')}
                        <div style="flex:1">
                            <div style="display:flex; align-items: center; gap: 8px;">
                                <span style="font-weight:bold">${escapeHtml(c.user)}</span>
                                <span class="comment-time">${c.timestamp}</span>
                            </div>
                            <div class="comment-text-clamped" id="ctext-${c.id}" style="margin-top:4px; line-height:1.4">${escapeHtml(c.text)}</div>
                            <button class="text-expand-btn" id="ctext-expand-${c.id}" onclick="toggleCommentText('${c.id}')">展开</button>
                            
                            <div class="comment-actions">
                                <button class="comment-action-btn ${likeClassC}" id="comment-btn-${c.id}-like" onclick="handleCommentLike(event, '${c.id}')">
                                    <img src="${likeIconC}" id="comment-img-${c.id}-like">
                                    <span id="comment-count-${c.id}-like">${c.likes && c.likes.length > 0 ? c.likes.length : ''}</span>
                                </button>
                                <button class="comment-action-btn" onclick="prepareReply('${c.id}', '${escapeHtml(c.user).replace(/'/g, "\\\\'")}')">
                                    <img src="${ICONS['comment']}">
                                    <span>回复</span>
                                </button>
                                ${replyCount > 0 ? `<span class="comment-time" style="margin-left:0;">${replyCount} 条回复</span>` : ''}
                            </div>

                            ${repliesHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // 构建单条二级评论 HTML
        function buildReplyItemHtml(r, currentUid) {
            const isLikeR = currentUid && r.likes && r.likes.includes(currentUid);
            const likeIconR = isLikeR ? ICONS['like_filled'] : ICONS['like'];
            const likeClassR = isLikeR ? 'active' : '';

            const avatarHtml = getAvatarHtml(r.avatar, r.user, 'avatar-tiny');

            return `
                <div class="reply-item">
                    ${avatarHtml}
                    <div class="reply-content">
                        <div class="reply-user-line">
                            <span class="reply-username">${escapeHtml(r.user)}</span>
                            <span class="comment-time">${r.timestamp}</span>
                        </div>
                        
                        <div class="comment-text-clamped" id="ctext-${r.id}" style="line-height:1.4; font-size:0.95rem;">${escapeHtml(r.text)}</div>
                        <button class="text-expand-btn" id="ctext-expand-${r.id}" onclick="toggleCommentText('${r.id}')">展开</button>

                        <div class="comment-actions">
                            <button class="comment-action-btn ${likeClassR}" id="comment-btn-${r.id}-like" onclick="handleCommentLike(event, '${r.id}')">
                                <img src="${likeIconR}" id="comment-img-${r.id}-like">
                                <span id="comment-count-${r.id}-like">${r.likes && r.likes.length > 0 ? r.likes.length : ''}</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // 展开/收起评论长文本（一级和二级通用）
        function toggleCommentText(id) {
            const textEl = document.getElementById(`ctext-${id}`);
            const btnEl = document.getElementById(`ctext-expand-${id}`);
            if (!textEl || !btnEl) return;

            if (textEl.classList.contains('comment-text-clamped')) {
                textEl.classList.remove('comment-text-clamped');
                btnEl.innerText = '收起';
            } else {
                textEl.classList.add('comment-text-clamped');
                btnEl.innerText = '展开';
            }
        }

        // 检查渲染后是否需要显示展开按钮
        function checkCommentTextOverflow() {
            document.querySelectorAll('.comment-text-clamped').forEach(el => {
                if (el.scrollHeight > el.clientHeight + 2) {
                    const id = el.id.replace('ctext-', '');
                    const btn = document.getElementById(`ctext-expand-${id}`);
                    if (btn) btn.style.display = 'inline-block';
                }
            });
        }

        // 显示/隐藏更多二级评论
        function toggleMoreReplies(commentId, hiddenCount) {
            const hiddenDiv = document.getElementById(`hidden-replies-${commentId}`);
            const btn = document.getElementById(`more-btn-${commentId}`);
            if (!hiddenDiv || !btn) return;

            if (hiddenDiv.style.display === 'none') {
                hiddenDiv.style.display = 'block';
                btn.innerText = '收起更多回复';
                // 检查新显示的文本是否需要展开按钮
                setTimeout(() => checkCommentTextOverflow(), 50);
            } else {
                hiddenDiv.style.display = 'none';
                btn.innerText = `查看更多 ${hiddenCount} 条回复`;
            }
        }

        // 准备回复一级评论
        function prepareReply(commentId, username) {
            const input = document.getElementById('floatCommentInput');
            if (!input) return;

            input.dataset.parentId = commentId;
            input.placeholder = `回复 @${username}...`;
            input.focus();

            input.addEventListener('blur', () => {
                if (input.value.trim() === '') {
                    input.removeAttribute('data-parent-id');
                    input.placeholder = '发布你的回复...';
                }
            }, { once: true });
        }

        // 评论点赞 (一用户一票)
        async function handleCommentLike(event, commentId) {
            event.stopPropagation();

            const uid = getUserId();
            if (!uid || uid.startsWith('visitor_')) {
                showToast("请登录后操作");
                return;
            }

            const btnEl = document.getElementById(`comment-btn-${commentId}-like`);
            const countEl = document.getElementById(`comment-count-${commentId}-like`);
            const imgEl = document.getElementById(`comment-img-${commentId}-like`);

            if (!btnEl || !countEl || !imgEl) return;

            const isLiked = btnEl.classList.contains('active');
            const action = isLiked ? 'remove' : 'add';
            let localCount = parseInt(countEl.innerText || '0', 10);

            if (action === 'add') {
                btnEl.classList.add('active');
                imgEl.src = ICONS['like_filled'];
                localCount++;
            } else {
                btnEl.classList.remove('active');
                imgEl.src = ICONS['like'];
                localCount = Math.max(0, localCount - 1);
            }
            countEl.innerText = localCount > 0 ? localCount : '';

            try {
                const res = await fetch(`${API_BASE}/comments/${commentId}/like`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ uid })
                });

                if (!res.ok) {
                    if (res.status === 401) showToast("请登录后操作");
                    throw new Error("Failed");
                }
                const data = await res.json();
                countEl.innerText = data.likesCount > 0 ? data.likesCount : '';

            } catch (e) {
                console.error("Comment like failed:", e);
                showToast("操作失败，请重试");
                if (action === 'add') {
                    btnEl.classList.remove('active');
                    imgEl.src = ICONS['like'];
                    localCount = Math.max(0, localCount - 1);
                } else {
                    btnEl.classList.add('active');
                    imgEl.src = ICONS['like_filled'];
                    localCount++;
                }
                countEl.innerText = localCount > 0 ? localCount : '';
            }
        }

        // ================= 收藏/标记 =================
        async function handleBookmark(event, tweetId) {
            event.stopPropagation();

            const uid = getUserId();
            if (!uid || uid.startsWith('visitor_')) {
                showToast("请登录后操作");
                return;
            }

            // 找到所有可能的按钮（列表、详情、搜索等视图可能同时存在同一推文的按钮）
            const allBtns = document.querySelectorAll(`[id$="-bookmark-${tweetId}"]`);

            try {
                const res = await fetch(`${API_BASE}/tweets/${tweetId}/bookmark`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ uid })
                });
                if (!res.ok) throw new Error("Bookmark failed");
                const data = await res.json();

                if (data.bookmarked) {
                    globalBookmarks.add(tweetId);
                } else {
                    globalBookmarks.delete(tweetId);
                }

                allBtns.forEach(btn => {
                    const imgEl = btn.querySelector('.bookmark-icon');
                    if (data.bookmarked) {
                        btn.classList.add('active-bookmark');
                        if (imgEl) {
                            imgEl.src = ICONS.bookmark_active;
                            imgEl.style.transform = 'scale(1.3)';
                            setTimeout(() => imgEl.style.transform = '', 200);
                        }
                    } else {
                        btn.classList.remove('active-bookmark');
                        if (imgEl) {
                            imgEl.src = ICONS.bookmark;
                            imgEl.style.transform = 'scale(0.95)';
                            setTimeout(() => imgEl.style.transform = '', 200);
                        }
                    }
                });


            } catch (e) {
                console.error(e);
                showToast("操作失败", 'error');
            }
        }

        // ================= 个人主页 =================
        let profileSort = 'desc'; // 'desc' = 最新在前, 'asc' = 最旧在前
        let profileTab = 'tweets'; // 'tweets' 或 'bookmarks'

        function openProfilePage() {
            const uid = getUserId();
            if (!uid || uid.startsWith('visitor_')) {
                showToast('请登录后操作');
                return;
            }
            // 隐藏其他视图
            document.getElementById('tweetListView').style.display = 'none';
            document.getElementById('tweetDetailView').style.display = 'none';
            const searchView = document.getElementById('searchResultView');
            if (searchView) searchView.style.display = 'none';
            document.getElementById('commentFloatBar').style.display = 'none';

            document.getElementById('profilePageView').style.display = 'block';
            document.body.classList.add('hide-sidebar-mobile');
            window.scrollTo(0, 0);

            profileTab = 'tweets';
            profileSort = 'desc';
            renderProfilePage();
        }

        function goBackFromProfile() {
            document.getElementById('profilePageView').style.display = 'none';
            document.getElementById('tweetListView').style.display = 'block';
            document.body.classList.remove('hide-sidebar-mobile');
            fetchTweets();
        }

        async function renderProfilePage() {
            const container = document.getElementById('profilePageContent');
            const uid = getUserId();

            // 从 API 获取最新资料，而非从侧边栏 DOM 读取，确保同步
            let avatarSrc = '';
            let nickname = '';
            let bio = '';
            let bannerUrl = '';
            try {
                const res = await fetch(`${API_BASE}/profile?uid=${encodeURIComponent(uid)}`);
                const profileData = await res.json();
                avatarSrc = profileData.avatar || '';
                nickname = profileData.nickname || '';
                bio = profileData.bio || '';
                bannerUrl = profileData.banner || '';
            } catch (e) {
                // 回退到侧边栏数据
                const profileAvatarImg = document.querySelector('#profileAvatarContainer img');
                avatarSrc = profileAvatarImg ? profileAvatarImg.src : '';
                nickname = document.getElementById('displayNickname').innerText;
                bio = document.getElementById('displayBio').innerText;
            }

            const bannerHtml = bannerUrl
                ? `<div class="profile-banner-bg" style="background-image:url('${bannerUrl}')"></div>`
                : '';
            const bannerClass = bannerUrl ? 'has-banner' : '';

            container.innerHTML = `
                <div class="profile-page-header ${bannerClass}">
                    ${bannerHtml}
                    ${getAvatarHtml(avatarSrc, nickname, 'profile-page-avatar')}
                    <div class="profile-page-name">${escapeHtml(nickname)}</div>
                    <div class="profile-page-bio">${escapeHtml(bio).replace(/\\n/g, '<br>').replace(/\n/g, '<br>')}</div>
                    <label class="banner-upload-btn">
                        <input type="file" accept="image/*" onchange="uploadBanner(this)" style="display:none;">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24"><path d="M19 7v2.99s-1.99.01-2 0V7h-3s.01-1.99 0-2h3V2h2v3h3v2h-3zm-3 4V8h-3V5H5c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-8h-3zM5 19l3-4 2 3 3-4 4 5H5z"/></svg>
                        ${bannerUrl ? '更换背景' : '添加背景'}
                    </label>
                </div>
                <div class="profile-tabs">
                    <button class="profile-tab ${profileTab === 'tweets' ? 'active' : ''}" onclick="switchProfileTab('tweets')">我的推文</button>
                    <button class="profile-tab ${profileTab === 'bookmarks' ? 'active' : ''}" onclick="switchProfileTab('bookmarks')">我的收藏</button>
                </div>
                <div id="profileTabContent"><div style="padding:20px; text-align:center; color:var(--text-secondary);">加载中...</div></div>
            `;

            await loadProfileTabContent();
        }

        // 上传主页背景图片
        async function uploadBanner(input) {
            const file = input.files[0];
            if (!file) return;

            const uid = getUserId();
            if (!uid || uid.startsWith('visitor_')) {
                showToast('请先登录');
                return;
            }

            const formData = new FormData();
            formData.append('uid', uid);
            formData.append('banner', file);

            try {
                const res = await fetch(`${API_BASE}/profile`, { method: 'POST', body: formData });
                if (res.ok) {
                    showToast('背景已更新', 'success');
                    renderProfilePage();
                } else {
                    const data = await res.json();
                    showToast(data.error || '上传失败', 'error');
                }
            } catch (e) {
                console.error(e);
                showToast('上传失败', 'error');
            }
        }

        function switchProfileTab(tab) {
            profileTab = tab;
            renderProfilePage();
        }



        async function loadProfileTabContent() {
            const contentDiv = document.getElementById('profileTabContent');
            if (!contentDiv) return;
            const uid = getUserId();

            try {
                let tweets = [];
                if (profileTab === 'tweets') {
                    const res = await fetch(`${API_BASE}/tweets`);
                    const all = await res.json();
                    tweets = all.filter(t => t.author_uid === uid);
                } else {
                    const res = await fetch(`${API_BASE}/bookmarks?uid=${uid}`);
                    tweets = await res.json();
                }

                // 排序：无论发表还是编辑都以最新为主（后台已经用编辑时间覆盖了 timestamp 面板），或用 localeCompare 解析
                tweets.sort((a, b) => {
                    // 对于新旧时间比较可能需要转成 Date，因为 timestamp 被改成了 "编于: 2026/..." 或者原生格式
                    // 这里可以直接获取时间戳数字或统一使用 id 倒序？用户要求“按照编辑时间排序而不是发表时间排序”
                    // 我们后端是直接更新的 timestamp 字段。直接按 timestamp 文本比较并不是很准，但对于标准的本地时间字符串往往可行
                    // 更稳妥的做法：
                    const aTime = extractSortableTime(a.timestamp);
                    const bTime = extractSortableTime(b.timestamp);
                    return bTime - aTime;
                });

                if (tweets.length === 0) {
                    contentDiv.innerHTML = `<div style="padding:40px; text-align:center; color:var(--text-secondary)">${profileTab === 'tweets' ? '还没有发布过推文' : '还没有收藏过推文'}</div>`;
                    return;
                }

                contentDiv.innerHTML = tweets.map(tweet => {
                    const tagsHtml = (tweet.tags || []).map(t => `<span class="clickable-tag" onclick="event.stopPropagation(); searchByTag('${escapeHtml(t)}')">#${escapeHtml(t)}</span>`).join('');
                    const commentCount = tweet.comments ? tweet.comments.length : 0;
                    const reactions = tweet.reactions || { like: 0, confused: 0, omg: 0 };

                    const reactionConfig = [
                        { type: 'like', icon: 'like', iconFilled: 'like_filled', count: reactions.like, colorClass: 'type-like' },
                        { type: 'confused', icon: 'confused', iconFilled: 'confused_filled', count: reactions.confused, colorClass: 'type-confused' },
                        { type: 'omg', icon: 'omg', iconFilled: 'omg_filled', count: reactions.omg, colorClass: 'type-omg' }
                    ];

                    let actionsHtml = `
                        <button class="action-item" onclick="event.stopPropagation(); openDetail('${tweet.id}')">
                            <img src="${ICONS.comment}" class="action-icon">
                            <span>${commentCount > 0 ? commentCount : ''}</span>
                        </button>
                    `;

                    reactionConfig.forEach(r => {
                        const isActive = hasUserReacted(tweet, r.type);
                        const currentIcon = isActive ? ICONS[r.iconFilled] : ICONS[r.icon];
                        const activeClass = isActive ? `active-${r.type}` : '';
                        actionsHtml += `
                            <button class="action-item ${r.colorClass} ${activeClass}"
                                onclick="handleReaction(event, '${tweet.id}', '${r.type}')"
                                id="profile-btn-${tweet.id}-${r.type}">
                                <img src="${currentIcon}" class="action-icon" id="profile-img-${tweet.id}-${r.type}">
                                <span id="profile-count-${tweet.id}-${r.type}">${r.count > 0 ? r.count : ''}</span>
                            </button>
                        `;
                    });

                    const isBookmarkedProfile = globalBookmarks.has(tweet.id);
                    const bookmarkClassProfile = isBookmarkedProfile ? 'active-bookmark' : '';

                    // 收藏按钮
                    actionsHtml += `
                        <button class="action-item ${bookmarkClassProfile}" onclick="handleBookmark(event, '${tweet.id}')" id="profile-bookmark-${tweet.id}">
                            <img src="${isBookmarkedProfile ? ICONS.bookmark_active : ICONS.bookmark}" class="action-icon bookmark-icon">
                        </button>
                    `;


                    // 媒体预览（与列表视图一致）
                    let mediaHtml = '';
                    let hasMedia = false;
                    const mediaList = tweet.media && tweet.media.length > 0 ? tweet.media : (tweet.mediaUrl ? [{ url: tweet.mediaUrl, type: tweet.mediaType }] : []);
                    if (mediaList.length > 0) {
                        hasMedia = true;
                        const first = mediaList[0];
                        if (first.type === 'video') {
                            mediaHtml = `<video src="${first.url}" controls></video>`;
                        } else {
                            mediaHtml = `<img src="${first.url}" loading="lazy">`;
                        }
                        if (mediaList.length > 1) {
                            mediaHtml += `<div class="media-count-badge">+${mediaList.length - 1} 更多...</div>`;
                        }
                    }

                    // 内容文字
                    let displayContentHtml = `<div class="tweet-text">${escapeHtml(tweet.content)}</div>`;
                    if (!tweet.content && (!tweet.tags || tweet.tags.length === 0) && mediaList.length > 0) {
                        let imgCount = 0, vidCount = 0;
                        mediaList.forEach(m => m.type === 'video' ? vidCount++ : imgCount++);
                        let parts = [];
                        if (imgCount > 0) parts.push(`${imgCount}张图片`);
                        if (vidCount > 0) parts.push(`${vidCount}个视频`);
                        displayContentHtml = `<div class="tweet-text" style="color:#bbbbbb; font-style:italic;">上传了${parts.join('和')}</div>`;
                    }

                    let originalTime = tweet.timestamp;
                    let editTimeStr = "";
                    if (tweet.timestamp && tweet.timestamp.includes('编于')) {
                        // timestamp 被我们篡改成了 '编于: ...'，如果我们需要 originalTime 只能后端保留，由于后端只覆盖了 timestamp 暂且我们就假设这被当做了当前时间，原时间前端不可知，可以假定为无。这里为了展示效果，直接解析后端返回字符串。
                        // 由于要求“点击一次变最初，点击一次变编于”，我们用 tweet.id 的前缀时间戳来充当 originalTime 就可以实现！因为推文的 ID 是 Date.now().toString() 创建的！
                        originalTime = new Date(parseInt(tweet.id)).toLocaleString();
                        editTimeStr = tweet.timestamp.replace('编于: ', '').trim();
                    }

                    let optionsMenuHtml = '';
                    if (tweet.author_uid === uid) {
                        optionsMenuHtml = `
                            <div style="position:relative;">
                                <button class="options-btn" onclick="toggleTweetOptions(event, '${tweet.id}')">···</button>
                                <div class="options-menu" id="options-menu-${tweet.id}">
                                    <button class="options-menu-item" onclick="event.stopPropagation(); toggleTweetOptions(event, '${tweet.id}'); startEditTweet('${tweet.id}')">编辑</button>
                                    <button class="options-menu-item danger" onclick="event.stopPropagation(); toggleTweetOptions(event, '${tweet.id}'); deleteTweet(event, '${tweet.id}')">删除</button>
                                </div>
                            </div>
                        `;
                    }

                    return `
                        <div class="card" style="cursor:pointer" onclick="openDetail('${tweet.id}')">
                            <div class="tweet-header">
                                ${getAvatarHtml(tweet.userAvatar, tweet.user, 'avatar-small')}
                                <div style="flex:1; display:flex; justify-content:space-between; align-items:center;">
                                    <span class="username">${escapeHtml(tweet.user)}</span>
                                    <div style="display:flex; align-items:center; gap:8px;">
                                        ${tweet.timestamp && (tweet.timestamp.includes('编于') || tweet.timestamp.includes('最后编辑于'))
                            ? `<span class="timestamp" id="profile-ts-${tweet.id}" style="cursor:pointer; color:var(--text-secondary);" onclick="toggleEditTimeDisplay(event, 'profile-ts-${tweet.id}', '${originalTime}', '${editTimeStr}')">最后编辑于 ${editTimeStr}</span>`
                            : `<span class="timestamp">${tweet.timestamp}</span>`
                        }
                                        ${optionsMenuHtml}
                                    </div>
                                </div>
                            </div>
                            <div class="tweet-body" style="display:block;">
                                <div style="display:flex; justify-content:space-between; gap:15px;">
                                    <div class="tweet-content-left">
                                        ${displayContentHtml}
                                        <div>${tagsHtml}</div>
                                    </div>
                                    <div class="tweet-media-right ${hasMedia ? 'active' : ''}">
                                        ${mediaHtml}
                                    </div>
                                </div>
                                <div class="tweet-footer">
                                    ${actionsHtml}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (e) {
                console.error(e);
                contentDiv.innerHTML = '<div style="padding:20px; color:red;">加载失败</div>';
            }
        }
        //辅助提取时间来排序
        function extractSortableTime(tsStr) {
            if (!tsStr) return 0;
            // 处理 "编于: YYYY/M/D HH:mm:ss" 或 "YYYY/MM/DD HH:mm:ss"
            let str = tsStr.replace('编于: ', '').trim();
            // 在某些环境 Date.parse("2023/1/1 12:00:00") 可行
            return new Date(str).getTime() || 0;
        }

        // 切换推文编辑时间状态显示
        function toggleEditTimeDisplay(event, elementId, originalTime, editTimeStr) {
            event.stopPropagation();
            const el = document.getElementById(elementId);
            if (!el) return;

            const currentText = el.innerText;
            if (currentText.includes('最后编辑于')) {
                // 如果当前是“最后编辑于”，则切换为“发表于 [时间]”
                el.innerText = `发表于 ${originalTime}`;
            } else {
                // 否则切换回“最后编辑于 [时间]”
                el.innerText = `最后编辑于 ${editTimeStr}`;
            }
        }

        // =========================
        // 新用户引导页 (Onboarding) - 动态从后端获取
        // =========================

        let currentOnboardingSlide = 0;
        let onboardingSteps = [];

        async function fetchGuideData() {
            try {
                const res = await fetch(`${API_BASE}/guide`);
                const data = await res.json();
                onboardingSteps = data.steps || [];
            } catch (err) {
                console.error("无法加载新手引导", err);
            }
        }

        // 页面初始化时检查
        async function checkOnboarding() {
            const uid = getUserId();
            if (!uid) return;

            const storageKey = 'hasSeenOnboarding_' + uid;

            if (!localStorage.getItem(storageKey)) {
                await fetchGuideData();
                if (onboardingSteps.length > 0) {
                    // 预加载所有幻灯片图片，避免切换时因网络请求导致拉伸动画卡顿
                    onboardingSteps.forEach(step => {
                        if (step.imageUrl) {
                            const preloadImg = new Image();
                            preloadImg.src = step.imageUrl;
                        }
                    });

                    // 初始显示欢迎界面
                    document.getElementById('onboardingWelcome').style.display = 'flex';
                    document.getElementById('dynamicOnboardingContainer').style.display = 'none';
                    document.getElementById('onboardingFooter').style.display = 'none';
                    document.getElementById('onboardingOverlay').style.display = 'flex';
                } else {
                    // 如果后端没有配置引导，直接标记完成
                    finishOnboarding(storageKey);
                }
            }
        }

        function startOnboardingSteps() {
            const welcome = document.getElementById('onboardingWelcome');
            const container = document.getElementById('dynamicOnboardingContainer');
            const footer = document.getElementById('onboardingFooter');
            const modal = document.querySelector('.onboarding-modal');

            // 1. 记录并固定旧高度，准备执行平滑拉伸
            const oldHeight = modal.getBoundingClientRect().height;
            modal.style.height = oldHeight + 'px';
            modal.style.transition = 'height 0.2s ease';

            // 欢迎页淡出
            welcome.classList.add('fade-out');

            setTimeout(() => {
                // 2. 隐藏欢迎页，预备并渲染新内容
                welcome.style.display = 'none';
                welcome.classList.remove('fade-out'); // 重置状态

                currentOnboardingSlide = 0;
                renderOnboardingSlide();

                // 3. 切换显示 dynamic container 和 footer，但让它们初始淡出
                container.style.display = 'flex';
                footer.style.display = 'flex';
                container.classList.add('fade-out');
                footer.classList.add('fade-out');

                // 4. 强制重排后计算新高度并执行动画
                modal.style.height = 'auto';
                const newHeight = modal.getBoundingClientRect().height;
                modal.style.height = oldHeight + 'px';
                modal.offsetHeight; // force reflow
                modal.style.height = newHeight + 'px';

                // 5. 内容淡入
                setTimeout(() => {
                    container.classList.remove('fade-out');
                    footer.classList.remove('fade-out');
                }, 50);

                // 6. 动画结束后，清除内联高度样式
                setTimeout(() => {
                    modal.style.height = '';
                    modal.style.transition = '';
                }, 200);
            }, 200);
        }

        window.addEventListener('load', () => {
            setTimeout(checkOnboarding, 500); // 延迟半秒弹出，体验更佳
        });

        // 移除原有的 openBeginnerGuide 手动触发函数

        function renderOnboardingSlide() {
            if (onboardingSteps.length === 0) return;
            const step = onboardingSteps[currentOnboardingSlide];

            const imgEl = document.getElementById('guideUserImg');
            const titleEl = document.getElementById('guideUserTitle');
            const textEl = document.getElementById('guideUserText');

            if (step.imageUrl) {
                imgEl.src = step.imageUrl;
                imgEl.style.display = 'block';
            } else {
                imgEl.style.display = 'none';
            }

            if (titleEl) {
                titleEl.textContent = step.title || '';
                titleEl.style.display = step.title ? 'block' : 'none';
            }
            textEl.textContent = step.text || '（暂无文字描述）';

            // 渲染圆点
            const dotsContainer = document.getElementById('guideUserDots');
            dotsContainer.innerHTML = '';
            for (let i = 0; i < onboardingSteps.length; i++) {
                const dot = document.createElement('div');
                dot.style.cssText = `width: 8px; height: 8px; border-radius: 50%; background: var(--border-color); transition: 0.3s;`;
                if (i === currentOnboardingSlide) {
                    dot.style.background = 'var(--primary-color)';
                    dot.style.width = '20px';
                    dot.style.borderRadius = '4px';
                }
                dotsContainer.appendChild(dot);
            }

            // 更新页码 x/y
            const pageCountEl = document.getElementById('guideUserPageCount');
            if (pageCountEl) {
                pageCountEl.textContent = `${currentOnboardingSlide + 1}/${onboardingSteps.length}`;
            }

            document.getElementById('guideUserPrevBtn').style.visibility = currentOnboardingSlide === 0 ? 'hidden' : 'visible';

            const nextBtn = document.getElementById('guideUserNextBtn');
            const skipBtn = document.getElementById('guideUserSkipBtn');
            if (currentOnboardingSlide === onboardingSteps.length - 1) {
                nextBtn.textContent = '完成';
                skipBtn.style.display = 'none';
            } else {
                nextBtn.textContent = '下一页';
                skipBtn.style.display = 'inline-block';
            }
        }

        function changeOnboardingSlide(direction) {
            const nextSlideIndex = currentOnboardingSlide + direction;

            if (nextSlideIndex >= onboardingSteps.length) {
                // 如果是最后一步触发的关闭，则使用对应特定的身份key记录
                const storageKey = currentUser && currentUser.startsWith('visitor_') ?
                    'hasSeenOnboarding_visitor' :
                    (currentUser ? 'hasSeenOnboarding_' + currentUser : 'hasSeenOnboarding_guest');
                finishOnboarding(storageKey);
                return;
            }

            // 平滑过渡效果
            const container = document.getElementById('dynamicOnboardingContainer');
            const modal = document.querySelector('.onboarding-modal');

            // 1. 记录并固定旧高度，准备执行高度拉伸动画
            const oldHeight = modal.getBoundingClientRect().height;
            modal.style.height = oldHeight + 'px';
            modal.style.transition = 'height 0.2s ease';

            container.classList.add('fade-out');

            setTimeout(() => {
                if (nextSlideIndex < 0) {
                    currentOnboardingSlide = 0;
                } else {
                    currentOnboardingSlide = nextSlideIndex;
                }

                // 2. 临时恢复 auto 以渲染新内容并测量新高度
                modal.style.height = 'auto';
                renderOnboardingSlide();
                const newHeight = modal.getBoundingClientRect().height;

                // 3. 恢复为旧高度，强制浏览器重排
                modal.style.height = oldHeight + 'px';
                modal.offsetHeight; // force reflow

                // 4. 将高度设置为新的目标高度，触发 CSS 过渡
                modal.style.height = newHeight + 'px';

                // 内容淡入
                container.classList.remove('fade-out');

                // 5. 动画结束后，清除内联样式，保持响应式
                setTimeout(() => {
                    modal.style.height = '';
                    modal.style.transition = '';
                }, 200);
            }, 200); // 与 CSS 中的 0.2s 对应
        }

        function finishOnboarding() {
            const uid = getUserId();
            if (uid) {
                localStorage.setItem('hasSeenOnboarding_' + uid, 'true');
            }

            // 淡出效果关闭
            const overlay = document.getElementById('onboardingOverlay');
            overlay.style.transition = 'opacity 0.3s ease';
            overlay.style.opacity = '0';
            setTimeout(() => {
                overlay.style.display = 'none';
                overlay.style.opacity = '1'; // 恢复状态以防再次调用
            }, 300);
        }

    </script>
</body>

</html>