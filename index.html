<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cyber?space v20260223</title>

    <style>
        /* =============== 黑色(默认) =============== */
        :root {
            --primary-color: #1d9bf0;
            --primary-hover: #1a8cd8;
            --bg-color: #000000;
            --card-bg: #000000;
            --text-color: #e7e9ea;
            --text-secondary: #71767b;
            --border-color: #2f3336;
            --input-bg: #000000;
            --transition-speed: 0.3s;
        }


        /* =============== 白色 =============== */
        body.light-mode {
            --primary-color: #1d9bf0;
            --bg-color: #ffffff;
            --card-bg: #ffffff;
            --text-color: #0f1419;
            --text-secondary: #536471;
            --border-color: #eff3f4;
            --input-bg: #eff3f4;
        }

        /* 黑色背景将图标颜色反转 */
        .theme-icon {
            filter: invert(1) brightness(2);
            transition: filter 0.3s ease;
        }

        /* 当切换到白色模式时，恢复图标原始颜色 */
        body.light-mode .theme-icon {
            filter: invert(0) brightness(1);
        }

        /* 全局过渡动画：确保边框和颜色同步切换 */
        * {
            transition: background-color var(--transition-speed),
                color var(--transition-speed),
                border-color var(--transition-speed),
                box-shadow var(--transition-speed);
            box-sizing: border-box;
        }

        /* =============== 全局样式 =============== */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            overflow-y: scroll;
            overflow-x: hidden;
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }

        .wrapper {
            display: flex;
            width: 100%;
            max-width: 1300px;
            gap: 60px;
            padding: 20px;
            margin: 0 auto;
            box-sizing: border-box;
            align-items: flex-start;
            /* 关键：防止 sidebar 撑满整列导致 sticky 失效 */
        }

        .sidebar {
            width: 320px;
            flex-shrink: 0;
            /* 防止被挤压 */
            position: sticky;
            top: 20px;
            /* 依靠外层 wrapper 的 flex gap 布局，无需 left/bottom 固定坐标 */
            max-height: calc(100vh - 40px);
            /* 减去上下间距，防止溢出视口 */
            overflow-y: auto;
            /* 内容过多时内部滚动 */
            scrollbar-width: none;
            /* Firefox 隐藏滚动条 */
            -ms-overflow-style: none;
            /* IE 10+ 隐藏滚动条 */
            background: var(--bg-color);
            /* 继承背景色，避免透明 */
            z-index: 100;
            /* 低于评论框的 1000，但高于普通内容 */
            border-radius: 16px;
            /* 保持原有圆角 */
            padding: 4px 12px;
            /* 为阴影留出空间 */
            box-sizing: border-box;
            /* 确保宽度和高度包含内边距 */
        }

        .sidebar::-webkit-scrollbar {
            /* Chrome/Safari 隐藏滚动条 */
            display: none;
        }

        .main-feed {
            flex: 1;
            min-width: 0;
            max-width: 850px;
            /* 由 wrapper 的 gap 自动分隔边距，不再手工指定 margin-left */
            border: 1px solid var(--border-color);
            border-radius: 16px;
            min-height: 100vh;
            border-top: none;
            border-bottom: none;
        }

        .card {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            position: relative;
        }

        .sidebar .card {
            border: 1px solid var(--border-color);
            border-radius: 16px;
            margin-bottom: 20px;
        }


        /* ================= 按钮与输入框 ================= */
        button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 9999px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }

        button:hover {
            background: var(--primary-hover);
        }


        button.btn-outline {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }

        button.btn-outline:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        body.light-mode button.btn-outline:hover {
            background: rgba(0, 0, 0, 0.05);
        }


        /* ================= 主题切换按钮 ================= */
        .theme-toggle-icon {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: transparent;
            z-index: 10;
            overflow: hidden;
        }

        .theme-toggle-icon:hover {
            background: rgba(29, 155, 240, 0.1);
        }

        .theme-toggle-icon img {
            position: absolute;
            width: 22px;
            height: 22px;
            transition: opacity var(--transition-speed) ease, transform var(--transition-speed) cubic-bezier(0.4, 0, 0.2, 1);
        }

        .icon-moon {
            opacity: 0;
            transform: scale(0.5) rotate(-90deg);
        }

        .icon-sun {
            opacity: 1;
            transform: scale(1) rotate(0deg);
        }

        body.light-mode .icon-moon {
            opacity: 1;
            transform: scale(1) rotate(0deg);
        }

        body.light-mode .icon-sun {
            opacity: 0;
            transform: scale(0.5) rotate(90deg);
        }


        /* ================= 搜索框 ================= */
        .search-container {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 9999px;
            padding: 0 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            margin-bottom: 20px;
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-container:focus-within {
            border-color: var(--primary-color);
        }

        .search-input {
            border: none;
            background: transparent;
            padding: 12px 40px 12px 8px;
            /* 右侧留出按钮空间 */
            width: 100%;
            font-size: 0.95rem;
            color: var(--text-color);
            outline: none;
        }

        .search-input:focus {
            border-color: var(--primary-color);
        }

        .search-icon-btn {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 8px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .search-icon-btn:hover {
            background: rgba(29, 155, 240, 0.1);
            color: var(--primary-color);
        }

        /* 搜索结果列表容器 */
        .search-result-list {
            padding: 0 16px;
        }

        /* ================= 发布框工具栏样式 ================= */
        /* 为了方便维护，将发布框底部的样式统一在这里管理 */

        textarea {
            width: 100%;
            background: transparent;
            border: none;
            border-bottom: 1px solid transparent;
            /* 默认隐藏线 */
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
            color: var(--text-color);
            padding: 10px 6px;
            resize: none;
            outline: none;
            font-size: 1.1rem;
            box-sizing: border-box;
        }

        textarea::-webkit-scrollbar {
            display: none;
        }

        textarea:focus {
            box-shadow:
                0 0 0 1.2px var(--primary-color);
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            /* 左右两端分布 */
            align-items: center;
            /* 垂直居中对齐 */
            margin-top: 15px;
        }

        .tools-left {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 15px;
        }

        .tool-item {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            color: var(--primary-color);
            font-size: 14px;
            transition: opacity 0.2s;
        }

        .tool-item:hover {
            opacity: 0.8;
        }

        .tool-icon {
            width: 20px;
            height: 20px;
            object-fit: contain;
        }

        /* 标签输入框的美化 */
        #tags {
            background: transparent;
            border: none;
            border-bottom: 1px solid transparent;
            color: var(--text-color);
            outline: none;
            width: 130px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        #tags:focus {
            border-bottom: 1px solid var(--primary-color);
        }

        #tags::placeholder {
            color: var(--text-secondary);
        }

        .post-btn {
            padding: 6px 20px;
            border-radius: 20px;
            font-size: 14px;
        }

        .sidebar .card:not(.profile-card) {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* ================= 个人资料卡 ================= */
        .profile-card {
            text-align: center;
            border: 1px solid var(--border-color) !important;
            padding: 20px;
            position: relative;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .profile-avatar-large {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 10px auto 10px;
            border: 2px solid var(--bg-color);
            object-fit: cover;
            background: var(--border-color);
        }

        .profile-name {
            font-weight: 800;
            font-size: 1.2rem;
            margin-bottom: 12px;
        }

        .profile-bio {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 15px;
        }


        /* ================= 推文布局 ================= */
        .tweet-header {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }

        .avatar-small {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            background: var(--border-color);
            object-fit: cover;
        }

        .username {
            font-weight: bold;
            margin-right: 5px;
            color: var(--text-color);
            font-size: 1.1rem;
        }

        .timestamp {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .tweet-body {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            margin-left: 50px;
        }

        .tweet-content-left {
            flex: 1;
            min-width: 0;
        }

        .tweet-text {
            font-size: 1rem;
            line-height: 1.5;
            white-space: pre-wrap;
            margin-bottom: 10px;
            color: var(--text-color);
        }

        .tweet-media-right {
            width: 120px;
            flex-shrink: 0;
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .tweet-media-right.active {
            display: flex;
        }

        .tweet-media-right img,
        .tweet-media-right video {
            width: 120px;
            height: 120px;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            object-fit: cover;
            display: block;
        }

        /* 强制推文文本换行 */
        .tweet-text {
            word-break: break-word;
            /* 兼容性更好 */
            overflow-wrap: break-word;
            /* 现代标准 */
        }

        /* 标签容器允许换行 */
        .tweet-content-left div:last-child {
            /* 标签所在的 div */
            display: flex;
            flex-wrap: wrap;
            gap: 4px 8px;
            /* 标签间距，可调整 */
        }

        /* 可选：确保左侧内容区不压缩 */
        .tweet-content-left {
            min-width: 0;
            /* 已有，确保 */
            width: 100%;
            /* 强制占满剩余空间 */
        }

        /*  reaction栏 */
        .tweet-footer {
            display: flex;
            justify-content: space-between;
            max-width: 450px;
            margin-top: 12px;
            padding: 0 10px;
        }

        .action-item {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 60px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 15px;
            background: transparent !important;
            border: none;
            padding: 6px 0;
            transition: color 0.2s ease;
            position: relative;
        }

        .action-item:hover {
            color: var(--primary-color);
        }

        /* Like: 红色 */
        .action-item.type-like:hover,
        .action-item.active-like {
            color: #f91880;
        }

        .action-item.type-like:hover .action-icon,
        .action-item.active-like .action-icon {
            filter: grayscale(0) opacity(1) !important;
        }

        /* Confused: 橙色 */
        .action-item.type-confused:hover,
        .action-item.active-confused {
            color: #fd7e14;
        }

        .action-item.type-confused:hover .action-icon,
        .action-item.active-confused .action-icon {
            filter: grayscale(0) opacity(1) !important;
        }

        /* OMG: 绿色 */
        .action-item.type-omg:hover,
        .action-item.active-omg {
            color: #82c91e;
        }

        .action-item.type-omg:hover .action-icon,
        .action-item.active-omg .action-icon {
            filter: grayscale(0) opacity(1) !important;
        }

        .action-icon {
            width: 20px;
            height: 20px;
            transition: transform 0.2s;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275), filter 0.3s ease;
            filter: grayscale(100%);
            /* 默认让图标变成灰色调，适应黑白主题 */
            opacity: 0.7;
        }

        /* 激活或 hover 时的图标效果 */
        .action-item:hover .action-icon,
        .action-item[class*="active-"] .action-icon {
            filter: grayscale(0);
            /* 恢复彩色 */
            opacity: 1;
            transform: scale(1.15);
            /* 微微放大 */
        }

        /* 只有深色模式下，非激活状态的图标需要反色才能看清(如果是黑色图标) */
        body:not(.light-mode) .action-icon {
            filter: invert(1) grayscale(100%) brightness(0.8);
            opacity: 0.8;
            transition: filter 0.3s ease, opacity 0.3s ease;
        }

        body:not(.light-mode) .action-item:hover .action-icon,
        body:not(.light-mode) .action-item[class*="active-"] .action-icon {
            filter: invert(0) grayscale(0) brightness(1);
            opacity: 1;
        }


        /* ================= Modal & Preview ================= */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            z-index: 2000;
            /* Increased to stay above comment float bar (which is 1000) */
            display: none;
            justify-content: center;
            align-items: center;
        }

        .modal {
            background: var(--bg-color);
            padding: 25px;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            border: 1px solid var(--border-color);
        }

        .modal input[type="text"] {
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            margin-bottom: 10px;
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            color: var(--text-color);
            box-sizing: border-box;
        }

        /* Modal 内部布局样式 */
        .modal-content-wrapper {
            display: flex;
            gap: 20px;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .modal-left-col {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .modal-right-col {
            width: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* 自定义上传按钮样式 */
        .upload-avatar-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--primary-color);
            border: 1px dashed var(--border-color);
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 5px;
            font-size: 0.9rem;
            justify-content: center;
            transition: 0.2s;
        }

        .upload-avatar-btn:hover {
            background: rgba(29, 155, 240, 0.1);
            border-color: var(--primary-color);
        }

        /* 头像预览圆图样式 */
        .avatar-preview-circle {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--border-color);
            background: var(--bg-color);
            margin-top: 5px;
        }

        .preview-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }


        #previewContainer {
            display: none;
            margin-top: 10px;
            position: relative;
        }

        .remove-preview {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            text-align: center;
            line-height: 24px;
            cursor: pointer;
            z-index: 5;
        }

        /* ================= 多文件预览网格 ================= */
        .preview-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }

        .preview-grid-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            aspect-ratio: 1;
            background: var(--border-color);
        }

        .preview-grid-item img,
        .preview-grid-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .preview-grid-item .remove-item {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(0, 0, 0, 0.75);
            color: white;
            border: none;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 14px;
            line-height: 22px;
            text-align: center;
            cursor: pointer;
            z-index: 5;
            padding: 0;
            transition: background 0.2s;
        }

        .preview-grid-item .remove-item:hover {
            background: rgba(255, 0, 0, 0.8);
        }

        /* ================= 列表页媒体计数徽标 ================= */
        .media-count-badge {
            color: var(--primary-color);
            font-size: 0.85rem;
            font-weight: bold;
            background: rgba(29, 155, 240, 0.1);
            padding: 4px 10px;
            border-radius: 12px;
            white-space: nowrap;
        }

        /* ================= 详情页多媒体网格 ================= */
        .media-grid {
            display: grid;
            gap: 4px;
            margin-top: 15px;
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            max-height: 600px;
        }

        .media-grid.media-grid-1 {
            grid-template-columns: 1fr;
        }

        .media-grid.media-grid-2 {
            grid-template-columns: 1fr 1fr;
        }

        .media-grid.media-grid-3 {
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
        }

        .media-grid.media-grid-3 .media-grid-item:first-child {
            grid-row: 1 / 3;
        }

        .media-grid.media-grid-4 {
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
        }

        .media-grid-item {
            overflow: hidden;
            cursor: zoom-in;
            position: relative;
            background: #000;
            min-height: 120px;
        }

        .media-grid-item img,
        .media-grid-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .media-grid-item .grid-more-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.55);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            font-weight: bold;
            pointer-events: none;
        }

        /* ================= Lightbox 导航 ================= */
        .lightbox-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border: none;
            font-size: 2rem;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            z-index: 2001;
            padding: 0;
        }

        .lightbox-nav:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .lightbox-nav.prev {
            left: 20px;
        }

        .lightbox-nav.next {
            right: 20px;
        }

        .lightbox-counter {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            background: rgba(0, 0, 0, 0.5);
            padding: 4px 12px;
            border-radius: 12px;
        }

        /* ================= 详情页与全屏组件 (新增) ================= */
        /* 1. 全屏查看器 */
        #mediaLightbox {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            cursor: zoom-out;
        }

        #lightboxContent img,
        #lightboxContent video {
            max-width: 95%;
            max-height: 90vh;
            border-radius: 4px;
        }

        /* ================= 搜索列表页头部 ================= */
        .search-header {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 10px 16px;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            background: var(--bg-color);
            z-index: 1001;
            /* Set higher than comment float bar */
        }

        /* 2. 详情页头部 */
        .detail-header {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 10px 16px;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            background: rgba(var(--bg-color), 0.85);
            /* 需配合 backdrop-filter */
            background: var(--bg-color);
            /* 降级方案 */
            z-index: 1001;
            /* Set higher than comment float bar (1000) so it doesn't get covered on narrow heights */
        }

        /* 3. 返回按钮 */
        .back-btn-circle {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: transparent;
            color: var(--text-color);
            cursor: pointer;
            transition: 0.2s;
            padding: 0;
        }

        .back-btn-circle:hover {
            background: rgba(29, 155, 240, 0.1);
        }

        /* 4. 详情页大图 */
        .detail-media-large {
            width: 100%;
            margin-top: 15px;
            border-radius: 16px;
            border: 1px solid var(--border-color);
            overflow: hidden;
            cursor: zoom-in;
            max-height: 600px;
        }

        .detail-media-large img,
        .detail-media-large video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
            background: #000;
        }

        /* 5. 评论区样式 */
        .comment-box-area {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 12px;
        }

        .comment-input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-color);
            font-size: 1.1rem;
            outline: none;
        }

        .comment-item {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 12px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        /* 底部悬浮评论框 */
        .comment-float-bar {
            position: fixed;
            /* 固定定位 */
            bottom: 20px;
            /* 距离视口底部 20px */
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            padding: 16px 18px 12px 18px;
            display: flex;
            gap: 12px;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            /* 确保在最上层 */
            transition: background-color var(--transition-speed),
                border-color var(--transition-speed),
                box-shadow var(--transition-speed);
            box-sizing: border-box;
            /* 移除之前的 margin 和 width:auto */
            width: auto;
            /* 宽度将由 JS 动态设置 */
            left: 0;
            /* 占位，实际由 JS 设置 */
        }

        /* 头像容器：垂直排列 */
        .comment-float-bar .avatar-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            gap: 4px;
            /* 头像与昵称间距 */
            flex-shrink: 0;
        }

        /* 昵称样式 */
        .comment-float-bar .avatar-nickname {
            font-size: 0.8rem;
            font-weight: bold;
            color: var(--text-secondary);
            max-width: 60px;
            /* 限制宽度，防止过长 */
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            text-align: center;
        }

        .comment-float-bar .avatar-small {
            margin-right: 0;
        }

        .comment-float-bar .comment-input {
            width: 100%;
            padding: 8px 12px 40px 12px;
            /* 底部留空避免按钮遮挡 */
            padding-right: 72px;
            /* 右侧为按钮留水平空间 */
            box-sizing: border-box;
            flex: 1;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            color: var(--text-color);
            font-size: 1rem;
            outline: none;
            resize: none;
            overflow-y: auto;
            min-height: 60px;
            max-height: 120px;
            line-height: 1.4;
            font-family: inherit;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .comment-float-bar .input-wrapper {
            flex: 1;
            /* 占满剩余宽度 */
            position: relative;
            /* 为按钮绝对定位提供参考 */
        }

        .comment-float-bar .comment-input::-webkit-scrollbar {
            display: none;
            /* Chrome/Safari 隐藏滚动条 */
        }

        .comment-float-bar .comment-input:focus {
            border-color: var(--primary-color);
        }

        .comment-float-bar .post-btn {
            position: absolute;
            bottom: 12px;
            right: 8px;
            padding: 4px 16px;
            font-size: 0.9rem;
            border-radius: 16px;
        }

        /* 为防止底部内容被固定栏遮挡，给详情容器增加底部内边距 */
        #tweetDetailView {
            display: none;
            /* 默认隐藏 */
            flex-direction: column;
            /* 垂直排列 */
        }

        #detailContent {
            /* 移除限制内部滚动的属性，让页面整体滚动 */
            padding: 0 16px 120px 16px;
        }

        /* 1. 详情页的推文文本强制换行 */
        #detailContent div[style*="font-size:1.4rem"] {
            word-break: break-word;
            overflow-wrap: break-word;
            white-space: pre-wrap;
            /* 保留换行符并自动换行 */
        }

        /* 2. 详情页的标签容器换行（多行显示） */
        #detailContent div[style*="margin: 10px 0 15px 0"] {
            display: flex;
            flex-wrap: wrap;
            gap: 4px 8px;
            /* 标签间距，可调整 */
        }

        /* 3. 列表页的标签换行 */
        .tweet-content-left div:last-child {
            display: flex;
            flex-wrap: wrap;
            gap: 4px 8px;
        }

        #tweetList .card:active {
            background-color: rgba(128, 128, 128, 0.2);
            /* 半透明灰色，适应深色/浅色主题 */
            transition: background-color 0.2s;
            /* 快速过渡，增强反馈感 */
        }

        /* ================= 响应式 ================= */
        @media (max-width: 850px) {
            body.hide-sidebar-mobile .sidebar {
                display: none !important;
            }

            .wrapper {
                flex-direction: column;
                /* 恢复原有 flex 列布局 */
                gap: 20px;
            }

            .sidebar {
                position: static;
                /* 取消固定定位 */
                width: 100%;
                max-height: none;
                overflow-y: visible;
                margin-bottom: 0;
                left: auto;
                top: auto;
            }

            .main-feed {
                margin-left: 0;
                /* 取消左边距 */
                max-width: 100%;
                width: 100%;
                /* Ensure it spans the full width available */
                border: none;
            }

            .modal-content-wrapper {
                flex-direction: column-reverse;
                align-items: center;
            }

            .modal-right-col {
                margin-bottom: 15px;
            }

            .comment-float-bar {
                left: 10px !important;
                right: 10px !important;
                width: calc(100% - 20px) !important;
                background: rgba(var(--bg-color), 0.95) !important;
                backdrop-filter: blur(10px);
                transform: none;
            }
        }
    </style>
</head>

<body>

    <div class="modal-overlay" id="editModal">
        <div class="modal">
            <h2 style="margin-top:0">修改资料</h2>

            <div class="modal-content-wrapper">
                <div class="modal-left-col">
                    <input type="text" id="editNickname" placeholder="昵称">
                    <input type="text" id="editBio" placeholder="简介">

                    <input type="file" id="editAvatarInput" accept="image/*" style="display:none;"
                        onchange="handleAvatarPreview(this)">
                    <label for="editAvatarInput" class="upload-avatar-btn">
                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                            <path
                                d="M19 7v2.99s-1.99.01-2 0V7h-3s.01-1.99 0-2h3V2h2v3h3v2h-3zm-3 4V8h-3V5H5c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-8h-3zM5 19l3-4 2 3 3-4 4 5H5z" />
                        </svg>
                        更换头像
                    </label>
                </div>

                <div class="modal-right-col">
                    <div class="preview-label">预览</div>
                    <img id="editAvatarPreview" class="avatar-preview-circle" src="" alt="Avatar Preview" />
                </div>
            </div>

            <div style="display:flex; gap:10px; margin-top:15px;">
                <button onclick="saveProfile()" style="flex:1">保存</button>
                <button onclick="closeModal()" class="btn-outline" style="flex:1">取消</button>
            </div>
        </div>
    </div>

    <div id="mediaLightbox" onclick="closeLightbox(event)">
        <button class="lightbox-nav prev" onclick="event.stopPropagation(); navigateLightbox(-1)">&#8249;</button>
        <div id="lightboxContent"></div>
        <button class="lightbox-nav next" onclick="event.stopPropagation(); navigateLightbox(1)">&#8250;</button>
        <div id="lightboxCounter" class="lightbox-counter" style="display:none;"></div>
    </div>

    <div class="wrapper">

        <div class="sidebar">

            <div class="card profile-card">
                <button class="theme-toggle-icon" onclick="toggleTheme()" id="themeBtn" title="切换主题">
                    <img src="https://img.icons8.com/?size=100&id=45475&format=png&color=FAB005" class="icon-sun"
                        alt="Sun">
                    <img src="https://img.icons8.com/?size=100&id=84045&format=png&color=FAB005" class="icon-moon"
                        alt="Moon">
                </button>

                <img src="" id="displayAvatar" class="profile-avatar-large" />
                <div class="profile-name" id="displayNickname">Loading...</div>
                <div class="profile-bio" id="displayBio">...</div>

                <button class="btn-outline" onclick="openModal()" style="width:100%">编辑资料</button>
            </div>

            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" placeholder="搜索..."
                    onkeydown="handleSearchKey(event)">
                <button class="search-icon-btn" onclick="performSearch()">
                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                        <path
                            d="M21.71 20.29l-5.01-5.01C17.54 13.68 18 11.91 18 10c0-4.41-3.59-8-8-8S2 5.59 2 10s3.59 8 8 8c1.91 0 3.68-.46 5.28-1.3l5.01 5.01c.39.39 1.02.39 1.41 0 .39-.39.39-1.02 0-1.41zM4 10c0-3.31 2.69-6 6-6s6 2.69 6 6-2.69 6-6 6-6-2.69-6-6z" />
                    </svg>
                </button>
            </div>

            <div class="card">
                <textarea id="content" placeholder="有什么新鲜事？" rows="6"></textarea>

                <div id="previewContainer">
                    <span class="remove-preview" onclick="clearPreview()" title="清空全部">×</span>
                    <div id="previewMedia"></div>
                </div>

                <div style="border-top: 1px solid var(--border-color); margin: 10px 0;"></div>

                <div class="toolbar">
                    <div class="tools-left">
                        <input type="file" id="fileInput" accept="image/*,video/*" multiple
                            onchange="handleFileSelect()" style="display:none;">
                        <label for="fileInput" class="tool-item">
                            <img src="https://img.icons8.com/?size=100&id=6b7l1lBTegrx&format=png&color=1A1A1A"
                                alt="icon" class="theme-icon tool-icon">
                            <span>图片/视频</span>
                        </label>

                        <div class="tool-item">
                            <img src="https://img.icons8.com/?size=100&id=119&format=png&color=000000" alt="tag"
                                class="theme-icon tool-icon">
                            <input type="text" id="tags" placeholder="添加标签, 逗号隔开">
                        </div>
                    </div>

                    <button onclick="postTweet()" class="post-btn">发布</button>
                </div>
            </div>
        </div>

        <div class="main-feed">
            <div id="tweetListView">
                <div id="tweetList"></div>
            </div>

            <div id="tweetDetailView" style="display: none;">
                <div class="detail-header">
                    <button class="back-btn-circle" onclick="goBackFromDetail()">
                        <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" />
                        </svg>
                    </button>
                    <span style="font-weight: 800; font-size: 1.2rem;">详情</span>
                </div>

                <div id="detailContent"></div>
            </div>

            <!-- 搜索结果视图（默认隐藏） -->
            <div id="searchResultView" style="display: none;">
                <div class="detail-header">
                    <button class="back-btn-circle" onclick="goBackFromSearch()">
                        <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" />
                        </svg>
                    </button>
                    <span id="searchResultTitle" style="font-weight: 800; font-size: 1.2rem;">搜索</span>
                </div>
                <div id="searchResultList" class="search-result-list"></div>
            </div>

        </div>

        <!-- 底部悬浮评论框（默认隐藏） -->
        <div id="commentFloatBar" class="comment-float-bar" style="display: none;">
            <div class="avatar-container">
                <img src="" id="floatAvatar" class="avatar-small" alt="">
                <span id="floatNickname" class="avatar-nickname">Loading...</span>
            </div>
            <div class="input-wrapper">
                <textarea id="floatCommentInput" class="comment-input" placeholder="发布你的评论..." rows="2"></textarea>
                <button id="floatPostCommentBtn" class="post-btn">评论</button>
            </div>
        </div>

    </div>

    <script>
        // 脚本：API 常量、页面状态、初始化、事件处理、API 交互、DOM 渲染
        const API_BASE = 'http://localhost:5000/api';
        let currentPostFiles = [];
        let lightboxItems = [];   // Lightbox 媒体列表
        let lightboxIndex = 0;    // 当前 Lightbox 索引
        let previousView = 'list'; // 可能值: 'list', 'search'

        const ICONS = {
            like: 'https://img.icons8.com/?size=100&id=86721&format=png&color=FA5252',
            like_filled: 'https://img.icons8.com/?size=100&id=86747&format=png&color=FA5252',
            confused: 'https://img.icons8.com/?size=100&id=85965&format=png&color=FAB005',
            confused_filled: 'https://img.icons8.com/?size=100&id=98973&format=png&color=FAB005',
            omg: 'https://img.icons8.com/?size=100&id=UpwQYGKI5ULX&format=png&color=000000',
            omg_filled: 'https://img.icons8.com/?size=100&id=UpwQYGKI5ULX&format=png&color=82C91E',
            comment: 'https://img.icons8.com/?size=100&id=q8JjcqIiTjN6&format=png&color=228BE6'
        };


        // 动态调整 textarea 的高度
        const autoResize = (el) => {
            el.style.height = 'auto';
            el.style.height = el.scrollHeight + 'px';
        };

        document.getElementById('content').addEventListener('input', function () {
            autoResize(this);
        });

        // 初始化时也执行一次（如果已有内容）
        autoResize(document.getElementById('content'));


        // =========================
        // 主题相关逻辑
        // =========================

        // 初始化主题（从 localStorage 恢复）
        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            // 如果之前存的是 light，就给 body 加上类名
            if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
            }
        }

        function toggleTheme() {
            // 切换类名：CSS 会根据这个类名的有无，自动触发图标的渐变动画
            document.body.classList.toggle('light-mode');

            // 保存当前用户的偏好
            const isLight = document.body.classList.contains('light-mode');
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
        }


        // =========================
        // 搜索相关
        // =========================

        // 回车触发搜索
        function handleSearchKey(event) {
            if (event.key === 'Enter') {
                performSearch();
            }
        }

        // 执行搜索：获取输入框的值并调用 fetchTweets 进行搜索
        async function performSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) return;

            // 更新标题
            document.getElementById('searchResultTitle').innerText = `"${query}"的搜索结果`;

            // 隐藏列表和详情，显示搜索结果视图
            document.getElementById('tweetListView').style.display = 'none';
            document.getElementById('tweetDetailView').style.display = 'none';
            document.getElementById('searchResultView').style.display = 'block';
            document.body.classList.add('hide-sidebar-mobile');

            // 隐藏评论悬浮框（如果显示着）
            const floatBar = document.getElementById('commentFloatBar');
            if (floatBar) floatBar.style.display = 'none';
            window.removeEventListener('resize', updateFloatBarPosition);

            // 获取搜索结果并渲染
            await fetchSearchResults(query);
        }


        // =========================
        // 页面初始化
        // =========================

        // 页面加载时，初始化主题、获取用户资料和推文列表
        window.onload = function () {
            initTheme();
            fetchProfile();
            fetchTweets();
        };


        // =========================
        // API：用户资料
        // =========================

        // 获取用户资料并更新页面显示，同时填充编辑 Modal 的初始值
        async function fetchProfile() {
            try {
                const res = await fetch(`${API_BASE}/profile`);
                const data = await res.json();

                // 更新展示区
                document.getElementById('displayNickname').innerText = data.nickname;
                document.getElementById('displayBio').innerText = data.bio || "暂无介绍";
                document.getElementById('displayAvatar').src = data.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(data.nickname)}&background=random`;

                // 填充编辑 Modal 的初始值
                document.getElementById('editNickname').value = data.nickname;
                document.getElementById('editBio').value = data.bio || "";
            } catch (e) {
                // 捕获并记录错误（不抛出)
                console.error(e);
            }
        }


        // =========================
        // API：推文列表
        // =========================

        // 获取推文列表（可选搜索），并调用渲染函数更新页面
        async function fetchTweets(query = '') {
            const url = query ? `${API_BASE}/tweets?search=${encodeURIComponent(query)}` : `${API_BASE}/tweets`;
            const res = await fetch(url);
            const data = await res.json();
            renderTweets(data);
        }

        // 记录该设备是否有过reaction
        function hasUserReacted(tweetId, type) {
            const key = `reacted_${tweetId}_${type}`;
            return localStorage.getItem(key) === 'true';
        }

        // 记录本地互动状态
        function saveUserReaction(tweetId, type) {
            const key = `reacted_${tweetId}_${type}`;
            localStorage.setItem(key, 'true');
        }

        // 将推文数据渲染到页面
        function renderTweets(tweets) {
            const list = document.getElementById('tweetList');
            list.innerHTML = '';

            // 如果没有推文显示提示
            if (!tweets.length) {
                list.innerHTML = `<div style="padding:40px; text-align:center; color:var(--text-secondary)">暂无内容</div>`;
                return;
            }

            tweets.forEach(tweet => {
                const card = document.createElement('div');
                card.className = 'card';
                card.style.cursor = 'pointer';

                // 点击卡片跳转详情
                card.onclick = (e) => {
                    // 如果点击的是按钮、图片或链接，不跳转
                    if (e.target.closest('button') || e.target.tagName === 'IMG' || e.target.tagName === 'VIDEO') return;
                    openDetail(tweet.id);
                };

                const avatarSrc = tweet.userAvatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(tweet.user)}&background=random`;

                let mediaHtml = '';
                let hasMedia = false;
                const mediaList = tweet.media && tweet.media.length > 0 ? tweet.media : (tweet.mediaUrl ? [{ url: tweet.mediaUrl, type: tweet.mediaType }] : []);

                if (mediaList.length > 0) {
                    hasMedia = true;
                    const first = mediaList[0];
                    if (first.type === 'video') {
                        mediaHtml = `<video src="${first.url}" controls></video>`;
                    } else {
                        mediaHtml = `<img src="${first.url}" loading="lazy">`;
                    }
                    if (mediaList.length > 1) {
                        mediaHtml += `<div class="media-count-badge">+${mediaList.length - 1} 更多...</div>`;
                    }
                }

                const tagsHtml = (tweet.tags || []).map(t => `<span style="color:var(--primary-color); margin-right:20px;">#${t}</span>`).join('');

                // reaction 状态与配置
                const commentCount = tweet.comments ? tweet.comments.length : 0;
                const reactions = tweet.reactions || { like: 0, confused: 0, omg: 0 };

                const reactionConfig = [
                    { type: 'like', icon: 'like', iconFilled: 'like_filled', count: reactions.like, colorClass: 'type-like' },
                    { type: 'confused', icon: 'confused', iconFilled: 'confused_filled', count: reactions.confused, colorClass: 'type-confused' },
                    { type: 'omg', icon: 'omg', iconFilled: 'omg_filled', count: reactions.omg, colorClass: 'type-omg' }
                ];

                // 生成 Reaction HTML
                let actionsHtml = `
                    <button class="action-item" onclick="event.stopPropagation(); openDetail('${tweet.id}')">
                        <img src="${ICONS.comment}" class="action-icon">
                        <span>${commentCount > 0 ? commentCount : ''}</span>
                    </button>
                `;

                reactionConfig.forEach(r => {
                    const isActive = hasUserReacted(tweet.id, r.type);
                    const currentIcon = isActive ? ICONS[r.iconFilled] : ICONS[r.icon];
                    const activeClass = isActive ? `active-${r.type}` : '';

                    // 这里 onclick 绑定了 handleReaction
                    actionsHtml += `
                        <button class="action-item ${r.colorClass} ${activeClass}" 
                            onclick="handleReaction(event, '${tweet.id}', '${r.type}')" 
                            id="btn-${tweet.id}-${r.type}">
                            <img src="${currentIcon}" class="action-icon" id="img-${tweet.id}-${r.type}">
                            <span id="count-${tweet.id}-${r.type}">${r.count > 0 ? r.count : ''}</span>
                        </button>
                    `;
                });

                // 媒体补充文字生成逻辑
                let displayContentHtml = `<div class="tweet-text">${escapeHtml(tweet.content)}</div>`;
                if (!tweet.content && (!tweet.tags || tweet.tags.length === 0) && mediaList.length > 0) {
                    let imgCount = 0;
                    let vidCount = 0;
                    mediaList.forEach(m => m.type === 'video' ? vidCount++ : imgCount++);

                    let mediaTextParts = [];
                    if (imgCount > 0) mediaTextParts.push(`${imgCount}张图片`);
                    if (vidCount > 0) mediaTextParts.push(`${vidCount}个视频`);

                    displayContentHtml = `<div class="tweet-text" style="color:#bbbbbb; font-style:italic;">上传了${mediaTextParts.join('和')}</div>`;
                }

                // 使用模板字符串分行提高可读性
                card.innerHTML = `
                <div class="tweet-header">
                    <img src="${avatarSrc}" class="avatar-small">
                    <div>
                        <span class="username">${escapeHtml(tweet.user)}</span>
                        <span class="timestamp">· ${tweet.timestamp}</span>
                    </div>
                </div>

                <div class="tweet-body" style="display:block;"> 
                    <div style="display:flex; justify-content:space-between; gap:15px;">
                        <div class="tweet-content-left">
                            ${displayContentHtml}
                            <div>${tagsHtml}</div>
                        </div>
                        <div class="tweet-media-right ${hasMedia ? 'active' : ''}">
                            ${mediaHtml}
                        </div>
                    </div>

                    <div class="tweet-footer">
                        ${actionsHtml}
                    </div>
                </div>
            `;

                list.appendChild(card);
            });
        }

        // 获取搜索结果
        async function fetchSearchResults(query) {
            const listContainer = document.getElementById('searchResultList');
            listContainer.innerHTML = '<div style="padding:40px; text-align:center;">加载中...</div>';

            try {
                const res = await fetch(`${API_BASE}/tweets?search=${encodeURIComponent(query)}`);
                if (!res.ok) throw new Error('搜索失败');
                const tweets = await res.json();
                renderSearchResults(tweets);
            } catch (e) {
                console.error(e);
                listContainer.innerHTML = '<div style="padding:40px; text-align:center; color:red;">加载失败</div>';
            }
        }

        // 渲染搜索结果
        function renderSearchResults(tweets) {
            const list = document.getElementById('searchResultList');
            list.innerHTML = '';

            if (!tweets.length) {
                list.innerHTML = `<div style="padding:40px; text-align:center; color:var(--text-secondary)">暂无内容</div>`;
                return;
            }

            tweets.forEach(tweet => {
                const card = document.createElement('div');
                card.className = 'card';
                card.style.cursor = 'pointer';

                card.onclick = (e) => {
                    if (e.target.closest('button') || e.target.tagName === 'IMG' || e.target.tagName === 'VIDEO') return;
                    // Let openDetail manage the transition to correctly record previousView
                    openDetail(tweet.id);
                };

                // 生成卡片内容（与 renderTweets 完全一致，可复制过来，但注意确保使用了 escapeHtml 等函数）
                const avatarSrc = tweet.userAvatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(tweet.user)}&background=random`;

                let mediaHtml = '';
                let hasMedia = false;
                const mediaList = tweet.media && tweet.media.length > 0 ? tweet.media : (tweet.mediaUrl ? [{ url: tweet.mediaUrl, type: tweet.mediaType }] : []);

                if (mediaList.length > 0) {
                    hasMedia = true;
                    const first = mediaList[0];
                    if (first.type === 'video') {
                        mediaHtml = `<video src="${first.url}" controls></video>`;
                    } else {
                        mediaHtml = `<img src="${first.url}" loading="lazy">`;
                    }
                    if (mediaList.length > 1) {
                        mediaHtml += `<div class="media-count-badge">+${mediaList.length - 1} 更多...</div>`;
                    }
                }

                const tagsHtml = (tweet.tags || []).map(t => `<span style="color:var(--primary-color); margin-right:20px;">#${t}</span>`).join('');

                const commentCount = tweet.comments ? tweet.comments.length : 0;
                const reactions = tweet.reactions || { like: 0, confused: 0, omg: 0 };

                const reactionConfig = [
                    { type: 'like', icon: 'like', iconFilled: 'like_filled', count: reactions.like, colorClass: 'type-like' },
                    { type: 'confused', icon: 'confused', iconFilled: 'confused_filled', count: reactions.confused, colorClass: 'type-confused' },
                    { type: 'omg', icon: 'omg', iconFilled: 'omg_filled', count: reactions.omg, colorClass: 'type-omg' }
                ];

                let actionsHtml = `
                    <button class="action-item" onclick="event.stopPropagation(); openDetail('${tweet.id}')">
                        <img src="${ICONS.comment}" class="action-icon">
                        <span>${commentCount > 0 ? commentCount : ''}</span>
                    </button>
                `;

                reactionConfig.forEach(r => {
                    const isActive = hasUserReacted(tweet.id, r.type);
                    const currentIcon = isActive ? ICONS[r.iconFilled] : ICONS[r.icon];
                    const activeClass = isActive ? `active-${r.type}` : '';
                    actionsHtml += `
                        <button class="action-item ${r.colorClass} ${activeClass}" 
                            onclick="handleReaction(event, '${tweet.id}', '${r.type}')" 
                            id="search-btn-${tweet.id}-${r.type}">
                            <img src="${currentIcon}" class="action-icon" id="search-img-${tweet.id}-${r.type}">
                            <span id="search-count-${tweet.id}-${r.type}">${r.count > 0 ? r.count : ''}</span>
                        </button>
                    `;
                });

                // 媒体补充文字生成逻辑
                let displayContentHtml = `<div class="tweet-text">${escapeHtml(tweet.content)}</div>`;
                if (!tweet.content && (!tweet.tags || tweet.tags.length === 0) && mediaList.length > 0) {
                    let imgCount = 0;
                    let vidCount = 0;
                    mediaList.forEach(m => m.type === 'video' ? vidCount++ : imgCount++);

                    let mediaTextParts = [];
                    if (imgCount > 0) mediaTextParts.push(`${imgCount}张图片`);
                    if (vidCount > 0) mediaTextParts.push(`${vidCount}个视频`);

                    displayContentHtml = `<div class="tweet-text" style="color:#bbbbbb; font-style:italic;">上传了${mediaTextParts.join('和')}</div>`;
                }

                card.innerHTML = `
                    <div class="tweet-header">
                        <img src="${avatarSrc}" class="avatar-small">
                        <div>
                            <span class="username">${escapeHtml(tweet.user)}</span>
                            <span class="timestamp">· ${tweet.timestamp}</span>
                        </div>
                    </div>
                    <div class="tweet-body" style="display:block;">
                        <div style="display:flex; justify-content:space-between; gap:15px;">
                            <div class="tweet-content-left">
                                ${displayContentHtml}
                                <div>${tagsHtml}</div>
                            </div>
                            <div class="tweet-media-right ${hasMedia ? 'active' : ''}">
                                ${mediaHtml}
                            </div>
                        </div>
                        <div class="tweet-footer">
                            ${actionsHtml}
                        </div>
                    </div>
                `;

                list.appendChild(card);
            });
        }


        // =========================
        // 发布推文
        // =========================

        // 发布推文（包含可选文件）
        async function postTweet() {
            const content = document.getElementById('content').value.trim();
            const tags = document.getElementById('tags').value.trim();

            if (!content && currentPostFiles.length === 0) return alert("内容不能为空");

            const formData = new FormData();
            formData.append('content', content);
            formData.append('tags', tags);
            currentPostFiles.forEach(f => formData.append('files', f));

            await fetch(`${API_BASE}/tweets`, { method: 'POST', body: formData });

            // 清理并刷新
            document.getElementById('content').value = '';
            document.getElementById('tags').value = '';
            clearPreview();
            fetchTweets();
        }


        // =========================
        // 保存资料
        // =========================

        // 将编辑 Modal 的资料提交到后端并刷新显示
        async function saveProfile() {
            const nickname = document.getElementById('editNickname').value;
            const bio = document.getElementById('editBio').value;
            const fileInput = document.getElementById('editAvatarInput');

            const formData = new FormData();
            formData.append('nickname', nickname);
            formData.append('bio', bio);
            if (fileInput.files[0]) formData.append('avatar', fileInput.files[0]);

            await fetch(`${API_BASE}/profile`, { method: 'POST', body: formData });

            closeModal();
            fetchProfile();
            fetchTweets();
        }


        // =========================
        // 预览与文件处理
        // =========================

        // 处理用户选择的文件（图片或视频）并创建本地预览
        function handleFileSelect() {
            const files = Array.from(document.getElementById('fileInput').files);
            if (!files.length) return;

            // 合并已有文件，限制最多9个
            const combined = [...currentPostFiles, ...files];
            if (combined.length > 9) {
                alert('最多只能上传9个文件');
                currentPostFiles = combined.slice(0, 9);
            } else {
                currentPostFiles = combined;
            }

            renderPreviewGrid();
        }

        // 渲染多文件预览网格
        function renderPreviewGrid() {
            const container = document.getElementById('previewContainer');
            const box = document.getElementById('previewMedia');

            if (currentPostFiles.length === 0) {
                container.style.display = 'none';
                box.innerHTML = '';
                return;
            }

            container.style.display = 'block';
            box.innerHTML = '';

            const grid = document.createElement('div');
            grid.className = 'preview-grid';

            currentPostFiles.forEach((file, idx) => {
                const item = document.createElement('div');
                item.className = 'preview-grid-item';

                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-item';
                removeBtn.innerHTML = '×';
                removeBtn.onclick = (e) => {
                    e.stopPropagation();
                    currentPostFiles.splice(idx, 1);
                    renderPreviewGrid();
                };
                item.appendChild(removeBtn);

                const reader = new FileReader();
                reader.onload = (e) => {
                    if (file.type.startsWith('video')) {
                        const vid = document.createElement('video');
                        vid.src = e.target.result;
                        vid.muted = true;
                        item.appendChild(vid);
                    } else {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        item.appendChild(img);
                    }
                };
                reader.readAsDataURL(file);

                grid.appendChild(item);
            });

            box.appendChild(grid);
        }

        // 处理修改头像时的实时预览
        function handleAvatarPreview(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('editAvatarPreview').src = e.target.result;
                }
                reader.readAsDataURL(file);
            }
        }

        // 清除当前预览并重置文件引用
        function clearPreview() {
            document.getElementById('fileInput').value = '';
            document.getElementById('previewContainer').style.display = 'none';
            document.getElementById('previewMedia').innerHTML = '';
            currentPostFiles = [];
        }

        // 处理点击互动 (Like, Confused, OMG)
        async function handleReaction(event, tweetId, type) {
            event.stopPropagation(); // 阻止事件冒泡 (防止未来点击卡片进入详情页时触发)

            const isReacted = hasUserReacted(tweetId, type);
            const action = isReacted ? 'remove' : 'add';

            // 定义需要更新的前缀列表：空字符串代表列表页 ID，'detail-' 代表详情页 ID, 'search-' 代表搜索页 ID, 使三个界面的数字同步
            const prefixes = ['', 'detail-', 'search-'];

            // 1. 先计算新数值 (避免在循环中重复计算导致数字错乱)
            // 尝试获取任意一个存在的计数器元素作为基准
            const baseCountSpan = document.getElementById(`detail-count-${tweetId}-${type}`) || document.getElementById(`search-count-${tweetId}-${type}`) || document.getElementById(`count-${tweetId}-${type}`);
            let currentCount = 0;
            if (baseCountSpan) {
                // 获取当前数字（如果是空字符串则视为 0）
                currentCount = parseInt(baseCountSpan.innerText) || 0;
            }

            // 计算目标值
            let newCount = currentCount;
            if (action === 'add') {
                if (!isReacted) newCount++; // 防止快速点击导致逻辑错误
            } else {
                if (isReacted) newCount--;
            }

            // 2. 遍历所有可能的界面位置 (列表页 + 详情页) 进行 乐观 UI 更新
            prefixes.forEach(prefix => {
                // 拼接对应的 ID
                const countId = `${prefix}count-${tweetId}-${type}`;
                const imgId = `${prefix}img-${tweetId}-${type}`;
                const btnId = `${prefix}btn-${tweetId}-${type}`;

                const countSpan = document.getElementById(countId);
                const imgEl = document.getElementById(imgId);
                const btnEl = document.getElementById(btnId);

                // 只有当元素存在于当前页面时才更新 (防止报错)
                if (countSpan && imgEl && btnEl) {

                    if (action === 'add') {
                        // 【增加逻辑】
                        // 增加后数字肯定大于 0，直接显示
                        countSpan.innerText = newCount;

                        btnEl.classList.add(`active-${type}`);
                        const filledKey = type === 'like' ? 'like_filled' : (type === 'omg' ? 'omg_filled' : 'confused_filled');
                        imgEl.src = ICONS[filledKey];

                        // 动画效果
                        imgEl.style.transform = 'scale(1.2)';
                        setTimeout(() => imgEl.style.transform = 'scale(1)', 200);

                    } else {
                        // 【取消逻辑】
                        // 关键修正：判断【新数字】是否大于 0
                        countSpan.innerText = newCount > 0 ? newCount : '';

                        btnEl.classList.remove(`active-${type}`);
                        imgEl.src = ICONS[type];

                        // 动画效果
                        imgEl.style.transform = 'scale(0.8)';
                        setTimeout(() => imgEl.style.transform = 'scale(1)', 200);
                    }
                }
            });

            // 3. 更新本地存储状态 (只需执行一次)
            if (action === 'add') {
                saveUserReaction(tweetId, type);
            } else {
                localStorage.removeItem(`reacted_${tweetId}_${type}`);
            }

            // 发送请求给后端
            try {
                const res = await fetch(`${API_BASE}/tweets/${tweetId}/react`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: type, action: action }) // 告诉后端动作
                });

                if (!res.ok) {
                    console.error("Reaction failed");
                }
            } catch (e) {
                console.error(e);
            }
        }

        // ===================
        // 详情页逻辑 
        // ===================

        // 更新悬浮框位置，使其与右侧主内容区对齐
        function updateFloatBarPosition() {
            const floatBar = document.getElementById('commentFloatBar');
            if (!floatBar || floatBar.style.display === 'none') return;
            // 如果是移动端（小于等于850px），让 CSS 处理，不设置 left/width
            if (window.innerWidth <= 850) {
                floatBar.style.left = '';
                floatBar.style.width = '';
                return;
            }
            const mainFeed = document.querySelector('.main-feed');
            if (!mainFeed) return;

            // 确保在任何屏幕尺寸下（哪怕非常宽），悬浮框大小完全随从主feed尺寸，修正坐标
            const rect = mainFeed.getBoundingClientRect();
            floatBar.style.left = rect.left + 15 + 'px';
            floatBar.style.width = rect.width - 30 + 'px';
        }

        // 打开详情页
        async function openDetail(id, isRefresh = false) {
            // 确保搜索结果视图被隐藏
            // 记录当前可见视图（如果是首次进入才记录状态）
            if (!isRefresh) {
                const searchView = document.getElementById('searchResultView');
                if (searchView && searchView.style.display === 'block') {
                    previousView = 'search';
                } else {
                    previousView = 'list';
                }
            }
            // 然后统一隐藏旧列表视图和搜索视图
            document.getElementById('tweetListView').style.display = 'none';
            const searchView = document.getElementById('searchResultView');
            if (searchView) searchView.style.display = 'none';

            // 1. 切换为主详情视图
            document.getElementById('tweetDetailView').style.display = 'block';
            document.body.classList.add('hide-sidebar-mobile');
            window.scrollTo(0, 0);

            const container = document.getElementById('detailContent');
            container.innerHTML = '<div style="padding:20px; text-align:center;">加载中...</div>';

            // 显示底部悬浮框
            const floatBar = document.getElementById('commentFloatBar');
            floatBar.style.display = 'flex';
            // 更新头像
            document.getElementById('floatAvatar').src = document.getElementById('displayAvatar').src;
            // 更新昵称
            document.getElementById('floatNickname').innerText = document.getElementById('displayNickname').innerText;
            // 清除输入框旧内容
            document.getElementById('floatCommentInput').value = '';

            // 更新位置
            updateFloatBarPosition();
            // 监听窗口大小变化
            window.addEventListener('resize', updateFloatBarPosition);

            // 为评论按钮绑定点击事件（注意避免重复绑定）
            const postBtn = document.getElementById('floatPostCommentBtn');
            // 移除之前绑定的事件（如果有）
            postBtn.replaceWith(postBtn.cloneNode(true));
            const newPostBtn = document.getElementById('floatPostCommentBtn');
            newPostBtn.addEventListener('click', function () {
                postComment(id); // 使用当前详情页的推文 id
            });

            // 同时允许回车发送
            const floatInput = document.getElementById('floatCommentInput');
            floatInput.onkeydown = function (e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();  // 阻止默认的换行
                    postComment(id);
                }
            };

            try {
                // 2. 获取数据
                const res = await fetch(`${API_BASE}/tweets/${id}`);
                if (!res.ok) throw new Error("加载失败");
                const tweet = await res.json();

                // 3. 构建标签 HTML
                const tagsHtml = (tweet.tags || []).map(t => `<span style="color:var(--primary-color); margin-right:15px; font-size:1.1rem; cursor:pointer;">#${t}</span>`).join('');

                // 4. 构建多媒体网格 HTML
                const mediaList = tweet.media && tweet.media.length > 0 ? tweet.media : (tweet.mediaUrl ? [{ url: tweet.mediaUrl, type: tweet.mediaType }] : []);
                let mediaHtml = '';
                if (mediaList.length > 0) {
                    const gridCount = Math.min(mediaList.length, 4);
                    const gridClass = `media-grid media-grid-${gridCount}`;
                    let gridItems = '';
                    mediaList.slice(0, 4).forEach((m, idx) => {
                        const isLast = idx === 3 && mediaList.length > 4;
                        const overlayHtml = isLast ? `<div class="grid-more-overlay">+${mediaList.length - 4}</div>` : '';
                        if (m.type === 'video') {
                            gridItems += `<div class="media-grid-item" onclick="openLightbox(${JSON.stringify(mediaList).replace(/"/g, '&quot;')}, ${idx})">
                                <video src="${m.url}" muted></video>${overlayHtml}</div>`;
                        } else {
                            gridItems += `<div class="media-grid-item" onclick="openLightbox(${JSON.stringify(mediaList).replace(/"/g, '&quot;')}, ${idx})">
                                <img src="${m.url}">${overlayHtml}</div>`;
                        }
                    });
                    mediaHtml = `<div class="${gridClass}">${gridItems}</div>`;
                }

                // 5. 构建评论列表 HTML
                const commentsHtml = (tweet.comments || []).map(c => `
                    <div class="comment-item">
                        <img src="${c.avatar || 'https://ui-avatars.com/api/?background=random'}" class="avatar-small">
                        <div style="flex:1">
                            <div style="display:flex; justify-content:space-between;">
                                <span style="font-weight:bold">${escapeHtml(c.user)}</span>
                                <span style="color:var(--text-secondary); font-size:0.85rem">${c.timestamp}</span>
                            </div>
                            <div style="margin-top:4px; line-height:1.4">${escapeHtml(c.text)}</div>
                        </div>
                    </div>
                `).join('');

                // 6. 渲染详情页 DOM
                // --- 动态生成 Reaction 按钮 HTML (逻辑与列表页一致) ---
                const reactions = tweet.reactions || { like: 0, confused: 0, omg: 0 };
                const reactionConfig = [
                    { type: 'like', icon: 'like', iconFilled: 'like_filled', count: reactions.like, colorClass: 'type-like' },
                    { type: 'confused', icon: 'confused', iconFilled: 'confused_filled', count: reactions.confused, colorClass: 'type-confused' },
                    { type: 'omg', icon: 'omg', iconFilled: 'omg_filled', count: reactions.omg, colorClass: 'type-omg' }
                ];

                let detailActionsHtml = '';
                reactionConfig.forEach(r => {
                    const isActive = hasUserReacted(tweet.id, r.type);
                    const currentIcon = isActive ? ICONS[r.iconFilled] : ICONS[r.icon];
                    const activeClass = isActive ? `active-${r.type}` : '';

                    // ID 增加了 'detail-' 前缀
                    detailActionsHtml += `
                        <button class="action-item ${r.colorClass} ${activeClass}" 
                            onclick="handleReaction(event, '${tweet.id}', '${r.type}')" 
                            id="detail-btn-${tweet.id}-${r.type}"
                            style="font-size: 0.9rem; padding: 5px 8px;"> 
                            <img src="${currentIcon}" class="action-icon" id="detail-img-${tweet.id}-${r.type}" style="width:20px; height:20px;">
                            <span id="detail-count-${tweet.id}-${r.type}" style="margin-left:4px; font-weight:bold;">${r.count > 0 ? r.count : ''}</span>
                        </button>
                    `;
                });

                // 详情页不再显示“上传了...”占位文字，仅显示实际内容（如果有）
                let displayContentHtml = tweet.content ? `<div style="font-size:1.4rem; margin:15px 0; line-height:1.4; white-space:pre-wrap;">${escapeHtml(tweet.content)}</div>` : '';

                container.innerHTML = `
                    <div style="padding: 0 16px;">
                        <div class="tweet-header" style="padding-top:15px;">
                            <img src="${tweet.userAvatar || `https://ui-avatars.com/api/?name=${tweet.user}`}" class="avatar-small" style="width:50px; height:50px;">
                            <div style="display:flex; flex-direction:column;">
                                <span class="username" style="font-size:1.1rem">${escapeHtml(tweet.user)}</span>
                                <span class="timestamp">${tweet.timestamp}</span>
                            </div>
                        </div>

                        ${displayContentHtml}

                        <div style="margin: 10px 0 15px 0;">${tagsHtml}</div>
                        
                        ${mediaHtml}

                        <div class="tweet-footer" style="padding:12px 0; justify-content: flex-start; gap: 120px; border-bottom:1px solid var(--border-color); margin:0;">
                            ${detailActionsHtml}
                        </div>
                    </div>

                    <div style="padding-bottom: 40px;">
                        ${commentsHtml}
                    </div>
                `;

            } catch (e) {
                console.error(e);
                container.innerHTML = '<div style="padding:20px; color:red">加载失败</div>';
            }
        }

        // 返回列表或搜索结果
        function goBackFromDetail() {
            document.getElementById('tweetDetailView').style.display = 'none';
            document.getElementById('commentFloatBar').style.display = 'none';
            window.removeEventListener('resize', updateFloatBarPosition);

            if (previousView === 'search') {
                // 显示搜索结果视图，并重新搜索以更新数据
                document.getElementById('searchResultView').style.display = 'block';
                // 此时仍在 search 视图，保持 hide-sidebar-mobile 状态
                const query = document.getElementById('searchInput').value.trim();
                if (query) {
                    fetchSearchResults(query); // 重新搜索保持数据最新
                }
            } else {
                document.getElementById('tweetListView').style.display = 'block';
                document.body.classList.remove('hide-sidebar-mobile');
                fetchTweets(); // 刷新列表
            }
        }

        // 从搜索结果返回列表
        function goBackFromSearch() {
            document.getElementById('searchResultView').style.display = 'none';
            document.getElementById('tweetListView').style.display = 'block';
            document.body.classList.remove('hide-sidebar-mobile');
            document.getElementById('searchResultList').innerHTML = ''; // 清空结果
            fetchTweets(); // 刷新列表
        }

        // 发送评论
        async function postComment(id) {
            const input = document.getElementById(`floatCommentInput`);
            const text = input.value.trim();
            if (!text) return;

            try {
                const res = await fetch(`${API_BASE}/tweets/${id}/comment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });
                // 评论成功后，重新加载详情页
                if (res.ok) {
                    input.value = '';
                    openDetail(id, true); // 传递 true 表示刷新，不覆盖 previousView
                } else {
                    const errorData = await res.json();
                    alert("评论失败: " + (errorData.error || "未知原因"));
                }
            } catch (e) {
                console.error("Comment Error:", e);
                alert("操作失败，请检查网络连接");
            }
        }

        // 全屏查看图片/视频 — 多图 Lightbox
        function openLightbox(mediaArray, startIndex) {
            lightboxItems = mediaArray;
            lightboxIndex = startIndex || 0;
            renderLightbox();
            document.getElementById('mediaLightbox').style.display = 'flex';

            // 显示/隐藏导航按钮
            const prevBtn = document.querySelector('.lightbox-nav.prev');
            const nextBtn = document.querySelector('.lightbox-nav.next');
            const counter = document.getElementById('lightboxCounter');
            if (lightboxItems.length > 1) {
                prevBtn.style.display = 'flex';
                nextBtn.style.display = 'flex';
                counter.style.display = 'block';
            } else {
                prevBtn.style.display = 'none';
                nextBtn.style.display = 'none';
                counter.style.display = 'none';
            }
        }

        function renderLightbox() {
            const content = document.getElementById('lightboxContent');
            const m = lightboxItems[lightboxIndex];
            if (m.type === 'video') {
                content.innerHTML = `<video src="${m.url}" controls autoplay style="max-width:90vw; max-height:90vh"></video>`;
            } else {
                content.innerHTML = `<img src="${m.url}" style="max-width:90vw; max-height:90vh">`;
            }
            const counter = document.getElementById('lightboxCounter');
            counter.textContent = `${lightboxIndex + 1} / ${lightboxItems.length}`;
        }

        function navigateLightbox(dir) {
            lightboxIndex = (lightboxIndex + dir + lightboxItems.length) % lightboxItems.length;
            renderLightbox();
        }

        function closeLightbox(e) {
            // 只有点击背景才关闭（不阻止内部元素点击）
            if (e.target === document.getElementById('mediaLightbox')) {
                document.getElementById('mediaLightbox').style.display = 'none';
                lightboxItems = [];
            }
        }

        // 向后兼容旧的 showFullMedia 调用
        function showFullMedia(url, type) {
            openLightbox([{ url, type }], 0);
        }

        // 键盘导航
        document.addEventListener('keydown', function (e) {
            const lb = document.getElementById('mediaLightbox');
            if (lb.style.display !== 'flex') return;
            if (e.key === 'ArrowLeft') navigateLightbox(-1);
            else if (e.key === 'ArrowRight') navigateLightbox(1);
            else if (e.key === 'Escape') { lb.style.display = 'none'; lightboxItems = []; }
        });


        // =========================
        // Modal 操作 / 安全工具
        // =========================

        // 打开编辑 Modal，并同步当前资料到预览区域
        function openModal() {
            // 打开时同步当前的头像到预览区域，避免显示空白或旧图
            const currentAvatarSrc = document.getElementById('displayAvatar').src;
            document.getElementById('editAvatarPreview').src = currentAvatarSrc;
            // 清空文件选择，以免上次选择的文件残留
            document.getElementById('editAvatarInput').value = "";

            document.getElementById('editModal').style.display = 'flex';
        }

        // 关闭 Modal
        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        // HTML 转义，防止 XSS 攻击
        function escapeHtml(text) {
            if (!text) return "";
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;");
        }
    </script>
</body>

</html>